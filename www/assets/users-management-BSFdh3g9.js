import{ap as _,r,a as $,b as Q,g as C,j as e,Y as T,L as h,t as E,I as b,b1 as q,be as J,v as V,ae as I,K,M as H,N as B,O as z,R as f,B as L,Q as N,X as x,aR as W,c as Z,f as ee,U as F,bB as se,bC as ae,i as te,aV as R,n as le,o as re,p as ie,bD as ne,q as ce,w as oe,x as de,y as ue,z as me,A as he}from"./index-B6h8JrZe.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const M=_("UserX",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"17",x2:"22",y1:"8",y2:"13",key:"3nzzx3"}],["line",{x1:"22",x2:"17",y1:"8",y2:"13",key:"1swrse"}]]);function xe({user:t,onSuccess:A,onCancel:p}){const[d,u]=r.useState(t?.email||""),[g,v]=r.useState(""),[m,S]=r.useState(t?.firstName||""),[o,i]=r.useState(t?.lastName||""),[y,k]=r.useState(t?.role||"user"),[l,w]=r.useState(t?.phone||""),{toast:j}=$(),U=Q(),c=C({mutationFn:async a=>t?x(`/api/users/${t.id}`,"PATCH",a):x("/api/auth/register","POST",{...a,fullName:`${a.firstName} ${a.lastName}`.trim()}),onSuccess:()=>{U.invalidateQueries({queryKey:N.users||["/api/users"]}),j({title:"تم بنجاح",description:t?"تم تحديث بيانات المستخدم":"تم إضافة المستخدم بنجاح"}),A?.()},onError:a=>{j({title:"خطأ",description:a.message,variant:"destructive"})}}),D=a=>{if(a.preventDefault(),!d||!t&&!g||!m||!o){j({title:"تنبيه",description:"يرجى ملء الحقول المطلوبة",variant:"destructive"});return}c.mutate({email:d,password:g||void 0,firstName:m,lastName:o,role:y,phone:l})};return e.jsxs("form",{onSubmit:D,className:"space-y-4",children:[e.jsxs(T,{columns:2,children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(h,{className:"flex items-center gap-2",children:[e.jsx(E,{className:"h-4 w-4 text-blue-500"}),"الاسم الأول *"]}),e.jsx(b,{value:m,onChange:a=>S(a.target.value),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(h,{className:"flex items-center gap-2",children:[e.jsx(E,{className:"h-4 w-4 text-blue-500"}),"الاسم الأخير *"]}),e.jsx(b,{value:o,onChange:a=>i(a.target.value),required:!0})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(h,{className:"flex items-center gap-2",children:[e.jsx(q,{className:"h-4 w-4 text-purple-500"}),"البريد الإلكتروني *"]}),e.jsx(b,{type:"email",value:d,onChange:a=>u(a.target.value),required:!0})]}),!t&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs(h,{className:"flex items-center gap-2",children:[e.jsx(J,{className:"h-4 w-4 text-red-500"}),"كلمة المرور *"]}),e.jsx(b,{type:"password",value:g,onChange:a=>v(a.target.value),required:!0})]}),e.jsxs(T,{columns:2,children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(h,{className:"flex items-center gap-2",children:[e.jsx(V,{className:"h-4 w-4 text-green-500"}),"رقم الهاتف"]}),e.jsx(b,{value:l,onChange:a=>w(a.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(h,{className:"flex items-center gap-2",children:[e.jsx(I,{className:"h-4 w-4 text-orange-500"}),"الصلاحية"]}),e.jsxs(K,{value:y,onValueChange:k,children:[e.jsx(H,{children:e.jsx(B,{})}),e.jsxs(z,{children:[e.jsx(f,{value:"admin",children:"مدير نظام"}),e.jsx(f,{value:"manager",children:"مدير مشروع"}),e.jsx(f,{value:"user",children:"مستخدم"})]})]})]})]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(L,{type:"submit",className:"flex-1",disabled:c.isPending,children:c.isPending?"جاري الحفظ...":t?"حفظ التعديلات":"إضافة مستخدم"}),e.jsx(L,{type:"button",variant:"outline",className:"flex-1",onClick:p,children:"إلغاء"})]})]})}function pe(){const{toast:t}=$(),{user:A}=W(),p=Q(),{setFloatingAction:d}=Z(),[u,g]=r.useState(""),[v,m]=r.useState(null),[S,o]=r.useState(!1),{data:i,isLoading:y,refetch:k}=ee({queryKey:N.users||["/api/users"],queryFn:async()=>await x("/api/users","GET")}),l=r.useMemo(()=>i?Array.isArray(i)?i:i.users&&Array.isArray(i.users)?i.users:i.data&&Array.isArray(i.data)?i.data:[]:[],[i]),w=C({mutationFn:async({userId:s,role:n})=>await x(`/api/users/${s}/role`,"PATCH",{role:n}),onSuccess:()=>{p.invalidateQueries({queryKey:N.users||["/api/users"]}),t({title:"تم تحديث الصلاحيات",description:"تم تغيير دور المستخدم بنجاح."})},onError:s=>{t({title:"فشل التحديث",description:s.message,variant:"destructive"})}}),j=C({mutationFn:async s=>x(`/api/users/${s}`,"DELETE"),onSuccess:()=>{p.invalidateQueries({queryKey:N.users||["/api/users"]}),t({title:"تم الحذف",description:"تم حذف المستخدم بنجاح"})},onError:s=>{t({title:"خطأ في الحذف",description:s.message,variant:"destructive"})}}),U=C({mutationFn:async({userId:s,isActive:n})=>x(`/api/users/${s}`,"PATCH",{isActive:!n}),onSuccess:()=>{p.invalidateQueries({queryKey:N.users||["/api/users"]}),t({title:"تم تحديث الحالة",description:"تم تغيير حالة المستخدم بنجاح"})}}),[c,D]=r.useState(!1),a=r.useMemo(()=>{if(!Array.isArray(l))return[];const s=u.toLowerCase();return l.filter(n=>{const P=!u||(n.fullName?.toLowerCase()||"").includes(s)||(n.firstName?.toLowerCase()||"").includes(s)||(n.lastName?.toLowerCase()||"").includes(s)||n.email?.toLowerCase().includes(s);return!u&&!c&&!n.isActive?!1:P})},[l,u,c]),Y=[{items:[{key:"total",label:"إجمالي المستخدمين",value:Array.isArray(l)?l.length:0,icon:F,color:"blue"},{key:"admins",label:"مدراء النظام",value:Array.isArray(l)?l.filter(s=>s.role==="admin").length:0,icon:I,color:"purple"},{key:"managers",label:"مدراء المشاريع",value:Array.isArray(l)?l.filter(s=>s.role==="manager").length:0,icon:se,color:"orange"},{key:"blocked",label:"المحظورين",value:Array.isArray(l)?l.filter(s=>!s.isActive).length:0,icon:M,color:"red"},{key:"unverified",label:"غير محققين",value:Array.isArray(l)?l.filter(s=>s.emailVerifiedAt===null||s.emailVerifiedAt===void 0).length:0,icon:q,color:"slate"}]}],G=()=>{m(null),o(!0)},O=s=>{m(s),o(!0)},X=s=>{window.confirm(`هل أنت متأكد من حذف المستخدم "${s.fullName||s.email}"؟`)&&j.mutate(s.id)};return r.useEffect(()=>(d(G,"إضافة مستخدم جديد"),()=>d(null)),[d]),y?e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsx(ae,{className:"h-8 w-8 animate-spin text-blue-600"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsx(te,{statsRows:Y,showSearch:!0,searchValue:u,onSearchChange:g,searchPlaceholder:"البحث عن مستخدم باسمه أو بريده...",onRefresh:()=>k(),isRefreshing:y,hideHeader:!0}),e.jsx("div",{className:"flex items-center gap-2 px-1",children:e.jsxs(L,{variant:c?"default":"outline",size:"sm",onClick:()=>D(!c),className:"rounded-xl font-bold gap-2",children:[c?e.jsx(R,{className:"h-4 w-4"}):e.jsx(M,{className:"h-4 w-4"}),c?"إخفاء المعطلين":"عرض جميع المستخدمين (بمن فيهم المعطلين)"]})}),e.jsx(le,{columns:3,children:a.length>0?a.map(s=>e.jsx(re,{title:s.fullName||`${s.firstName} ${s.lastName}`,subtitle:s.email,titleIcon:E,headerColor:s.role==="admin"?"#9333ea":s.role==="manager"?"#f97316":"#2563eb",badges:[{label:s.role==="admin"?"مدير نظام":s.role==="manager"?"مدير مشروع":"مستخدم",variant:s.role==="admin"?"default":s.role==="manager"?"secondary":"outline"},{label:s.isActive?"نشط":"معطل",variant:s.isActive?"success":"destructive"}],fields:[{label:"البريد",value:s.email,icon:q,color:"purple"},{label:"رقم الهاتف",value:s.phone||"غير محدد",icon:V,color:s.phone?"success":"muted"},{label:"تاريخ الانضمام",value:s.createdAt?new Date(s.createdAt).toLocaleDateString("ar-YE"):"-",icon:R,color:"blue"}],actions:[{icon:ie,label:"تعديل",onClick:()=>O(s),color:"blue"},{icon:ne,label:s.isActive?"تعطيل":"تفعيل",onClick:()=>U.mutate({userId:s.id,isActive:s.isActive}),color:s.isActive?"yellow":"green"},{icon:ce,label:"حذف",onClick:()=>X(s),color:"red",disabled:s.id===A?.id}],footer:e.jsxs("div",{className:"flex flex-col gap-2 mt-2 pt-2 border-t border-slate-100 dark:border-slate-800",children:[e.jsx("label",{className:"text-xs font-bold text-slate-500",children:"تغيير الصلاحية السريع"}),e.jsxs(K,{defaultValue:s.role,onValueChange:n=>w.mutate({userId:s.id,role:n}),disabled:w.isPending||s.id===A?.id,children:[e.jsx(H,{className:"w-full h-9 rounded-xl font-bold border-slate-200 dark:border-slate-700",children:e.jsx(B,{placeholder:"اختر الدور"})}),e.jsxs(z,{className:"rounded-xl border-slate-200 dark:border-slate-800",children:[e.jsx(f,{value:"admin",className:"font-bold",children:"مدير نظام"}),e.jsx(f,{value:"manager",className:"font-bold",children:"مدير مشروع"}),e.jsx(f,{value:"user",className:"font-bold",children:"مستخدم"})]})]})]}),compact:!0},s.id)):e.jsxs("div",{className:"col-span-full py-12 text-center bg-white/50 dark:bg-slate-900/50 rounded-3xl border-2 border-dashed border-slate-200 dark:border-slate-800",children:[e.jsx(F,{className:"h-12 w-12 text-slate-300 mx-auto mb-4"}),e.jsx("p",{className:"text-slate-500 font-bold",children:"لا يوجد مستخدمين لعرضهم"})]})}),e.jsx(oe,{open:S,onOpenChange:o,children:e.jsxs(de,{className:"sm:max-w-md rounded-3xl",children:[e.jsxs(ue,{children:[e.jsx(me,{className:"text-xl font-bold",children:v?"تعديل بيانات المستخدم":"إضافة مستخدم جديد"}),e.jsx(he,{children:v?"تعديل الصلاحيات والبيانات الأساسية":"إنشاء حساب جديد للموظف أو المدير"})]}),e.jsx("div",{className:"mt-4",children:e.jsx(xe,{user:v,onSuccess:()=>o(!1),onCancel:()=>o(!1)})})]})})]})}export{pe as default};
