const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-myP1U0Y8.js","assets/index-D9735cVd.css"])))=>i.map(i=>d[i]);
import{u as Ee,r as l,a as Le,b as Re,c as $e,d as We,f as Y,g as J,h as qe,S as X,D as me,U as ze,W as _e,C as Ke,T as Qe,Q as u,j as t,i as Ve,k as Ue,l as fe,m as pe,B as Z,P as Oe,n as Ge,o as Be,p as He,q as Ye,s as Je,t as ge,v as Xe,w as Ze,x as et,y as tt,z as rt,A as at,L as w,E as st,F as nt,I as ot,G as lt,H as it,J as Q,K as ct,M as dt,N as ut,O as ht,R as ee,_ as mt,V as ft,X as $}from"./index-myP1U0Y8.js";function xt(){Ee();const[we,b]=l.useState(!1),[I,C]=l.useState(null),[j,te]=l.useState(""),[h,re]=l.useState("all"),[m,ae]=l.useState("all"),[A,se]=l.useState(""),[F,ne]=l.useState(""),[P,oe]=l.useState(""),[be,le]=l.useState(!1),{toast:k}=Le(),f=Re(),{setFloatingAction:V}=$e(),{selectedProjectId:T,getProjectIdForApi:xe}=We(),p=xe()||"",W=async(e,r)=>{if(!(!r||r.trim().length<2))try{await $("/api/autocomplete","POST",{category:e,value:r.trim(),usageCount:1})}catch(n){console.error(`خطأ في حفظ قيمة الإكمال التلقائي ${e}:`,n)}},[a,c]=l.useState({workerId:"",projectId:"",amount:0,recipientName:"",recipientPhone:"",transferMethod:"hawaleh",transferNumber:"",transferDate:new Date().toISOString().split("T")[0],notes:""}),q=async()=>{const e=[];a.recipientName&&a.recipientName.trim().length>=2&&e.push(W("recipientNames",a.recipientName)),a.recipientPhone&&a.recipientPhone.trim().length>=3&&e.push(W("recipientPhones",a.recipientPhone)),a.transferNumber&&a.transferNumber.trim().length>=1&&e.push(W("workerTransferNumbers",a.transferNumber)),a.notes&&a.notes.trim().length>=2&&e.push(W("workerTransferNotes",a.notes)),e.length>0&&await Promise.all(e)},ie=new URLSearchParams(window.location.search),U=ie.get("edit"),ce=ie.get("worker"),{data:v=[],isLoading:pt}=Y({queryKey:u.workers,select:e=>Array.isArray(e)?e.filter(r=>r.isActive):[]}),{data:O=[]}=Y({queryKey:u.projects,select:e=>Array.isArray(e)?e:[]}),{data:M=[],isLoading:ye}=Y({queryKey:u.workerTransfers(T),queryFn:async()=>{const e=p?`/api/worker-transfers?projectId=${p}`:"/api/worker-transfers",r=await $(e,"GET");return Array.isArray(r?.data)?r.data:Array.isArray(r)?r:[]}});l.useEffect(()=>(V(()=>{C(null),c({workerId:ce||"",projectId:"",amount:0,recipientName:"",recipientPhone:"",transferMethod:"hawaleh",transferNumber:"",transferDate:new Date().toISOString().split("T")[0],notes:""}),b(!0)},"إضافة حولة جديدة"),()=>{V(null)}),[V,ce]);const G=J({mutationFn:async e=>(await q(),$("/api/worker-transfers","POST",e)),onSuccess:()=>{f.refetchQueries({queryKey:u.workerTransfers(T)}),f.refetchQueries({queryKey:u.autocomplete}),b(!1),z(),k({title:"تم بنجاح",description:"تم إرسال الحولة بنجاح"})},onError:async e=>{await q(),f.refetchQueries({queryKey:u.autocomplete});let r="فشل في إرسال الحولة";e?.response?.data?.message?r=e.response.data.message:e?.message&&(r=e.message),k({title:"خطأ",description:r,variant:"destructive"})}}),B=J({mutationFn:async e=>(await q(),$(`/api/worker-transfers/${e.id}`,"PATCH",e.updates)),onSuccess:()=>{f.refetchQueries({queryKey:u.workerTransfers(T)}),f.refetchQueries({queryKey:u.autocomplete}),b(!1),C(null),z(),k({title:"تم بنجاح",description:"تم تحديث الحولة بنجاح"})},onError:async e=>{await q(),f.refetchQueries({queryKey:u.autocomplete});let r="فشل في تحديث الحولة";e?.response?.data?.message?r=e.response.data.message:e?.message&&(r=e.message),k({title:"خطأ",description:r,variant:"destructive"})}}),je=J({mutationFn:async e=>$(`/api/worker-transfers/${e}`,"DELETE"),onSuccess:()=>{f.refetchQueries({queryKey:u.workerTransfers(T)}),k({title:"تم بنجاح",description:"تم حذف الحولة بنجاح"})},onError:e=>{let r="فشل في حذف الحولة";e?.response?.data?.message?r=e.response.data.message:e?.message&&(r=e.message),k({title:"خطأ",description:r,variant:"destructive"})}});l.useEffect(()=>{if(U&&M.length>0){const e=M.find(r=>r.id===U);e&&(C(e),c({workerId:e.workerId,projectId:e.projectId,amount:e.amount,recipientName:e.recipientName,recipientPhone:e.recipientPhone||"",transferMethod:e.transferMethod,transferNumber:e.transferNumber||"",transferDate:e.transferDate,notes:e.notes||""}),b(!0))}},[U,M]);const z=()=>{c({workerId:"",projectId:"",amount:0,recipientName:"",recipientPhone:"",transferMethod:"hawaleh",transferNumber:"",transferDate:new Date().toISOString().split("T")[0],notes:""})},ke=()=>{if(!a.workerId||!a.projectId||!a.amount||!a.recipientName||!a.transferDate){k({title:"خطأ",description:"الرجاء ملء جميع الحقول المطلوبة",variant:"destructive"});return}I?B.mutate({id:I.id,updates:a}):G.mutate(a)},ve=e=>{C(e),c({workerId:e.workerId,projectId:e.projectId,amount:e.amount,recipientName:e.recipientName,recipientPhone:e.recipientPhone||"",transferMethod:e.transferMethod,transferNumber:e.transferNumber||"",transferDate:e.transferDate,notes:e.notes||""}),b(!0)},N=e=>`${(typeof e=="string"?parseFloat(e):e).toLocaleString("en-US")} ر.ي`,de=e=>new Date(e).toLocaleDateString("en-GB",{year:"numeric",month:"2-digit",day:"2-digit"}),ue=e=>{switch(e){case"cash":return"نقداً";case"bank":return"تحويل بنكي";case"hawaleh":return"حولة";default:return e}},i=l.useMemo(()=>{let e=[...M];if(p&&p!=="all"&&(e=e.filter(r=>r.projectId===p)),h&&h!=="all"&&(e=e.filter(r=>r.workerId===h)),m&&m!=="all"&&(e=e.filter(r=>r.transferMethod===m)),j){const r=j.toLowerCase();e=e.filter(n=>v.find(y=>y.id===n.workerId)?.name.toLowerCase().includes(r)||n.recipientName.toLowerCase().includes(r)||n.notes?.toLowerCase().includes(r))}return A&&(e=e.filter(r=>new Date(r.transferDate)>=new Date(A))),F&&(e=e.filter(r=>new Date(r.transferDate)<=new Date(F))),P&&(e=e.filter(r=>{const n=new Date(r.transferDate),s=new Date(P);return n.getFullYear()===s.getFullYear()&&n.getMonth()===s.getMonth()&&n.getDate()===s.getDate()})),e},[M,p,h,m,j,A,F,P,v]),{summary:he,isLoading:gt}=qe(),x=l.useMemo(()=>{const e=i.reduce((o,g)=>o+(Number(g.amount)||0),0),r=i.filter(o=>o.transferMethod==="cash"),n=i.filter(o=>o.transferMethod==="bank"),s=i.filter(o=>o.transferMethod==="hawaleh"),y=r.reduce((o,g)=>o+(Number(g.amount)||0),0),D=n.reduce((o,g)=>o+(Number(g.amount)||0),0),H=s.reduce((o,g)=>o+(Number(g.amount)||0),0),_=new Set(i.map(o=>o.workerId)).size,E=p&&p!=="all"||h&&h!=="all"||m&&m!=="all"||j||A||F||P;return{totalTransfers:i.length,totalAmount:E?e:he?.totalWorkerTransfers||e,cashAmount:y,bankAmount:D,hawalehAmount:H,uniqueWorkers:_,averageTransfer:i.length>0?e/i.length:0}},[i,he,p,h,m,j,A,F,P]),Ne=l.useMemo(()=>[{columns:3,gap:"sm",items:[{key:"totalTransfers",label:"إجمالي الحوالات",value:x.totalTransfers.toString(),icon:X,color:"blue"},{key:"totalAmount",label:"إجمالي المبالغ",value:N(x.totalAmount),icon:me,color:"green"},{key:"uniqueWorkers",label:"عدد العمال",value:x.uniqueWorkers.toString(),icon:ze,color:"purple"},{key:"cashAmount",label:"نقداً",value:N(x.cashAmount),icon:_e,color:"emerald"},{key:"bankAmount",label:"تحويل بنكي",value:N(x.bankAmount),icon:Ke,color:"orange"},{key:"hawalehAmount",label:"حوالات",value:N(x.hawalehAmount),icon:Qe,color:"teal"}]}],[x,N]),Ce=l.useMemo(()=>[{key:"worker",label:"العامل",type:"select",placeholder:"اختر العامل",options:[{value:"all",label:"جميع العمال"},...v.map(e=>({value:e.id,label:`${e.name} (${e.type})`}))]},{key:"transferMethod",label:"طريقة التحويل",type:"select",placeholder:"طريقة التحويل",options:[{value:"all",label:"جميع الطرق"},{value:"cash",label:"نقداً"},{value:"bank",label:"تحويل بنكي"},{value:"hawaleh",label:"حولة"}]},{key:"dateFrom",label:"من تاريخ",type:"date",placeholder:"من تاريخ"},{key:"dateTo",label:"إلى تاريخ",type:"date",placeholder:"إلى تاريخ"},{key:"specificDate",label:"تاريخ يوم محدد",type:"date",placeholder:"تاريخ يوم محدد"}],[v]),Te=l.useCallback((e,r)=>{e==="worker"?re(r):e==="transferMethod"?ae(r):e==="dateFrom"?se(r):e==="dateTo"?ne(r):e==="specificDate"&&oe(r)},[]),De=l.useCallback(()=>{re("all"),ae("all"),te(""),se(""),ne(""),oe("")},[]),Se=l.useCallback(async()=>{le(!0),await f.refetchQueries({queryKey:u.workerTransfers(T)}),le(!1)},[f,T]),Ie=async()=>{if(i.length===0)return;const e=(await mt(async()=>{const{default:d}=await import("./index-myP1U0Y8.js").then(L=>L.e);return{default:d}},__vite__mapDeps([0,1]))).default,r=new e.Workbook,n=r.addWorksheet("حوالات العمال");n.views=[{rightToLeft:!0}],n.pageSetup={paperSize:9,orientation:"landscape",fitToPage:!0,fitToWidth:1,fitToHeight:0,margins:{left:.2,right:.2,top:.3,bottom:.3,header:.1,footer:.1},horizontalCentered:!0,scale:80},n.columns=[{width:5},{width:12},{width:15},{width:15},{width:12},{width:12},{width:15},{width:12},{width:20}];let s=1;n.mergeCells(`A${s}:I${s}`);const y=n.getCell(`A${s}`);y.value="الفتيني للمقاولات العامة والاستشارات الهندسية",y.font={name:"Arial",size:14,bold:!0,color:{argb:"FFFFFF"}},y.alignment={horizontal:"center",vertical:"middle"},y.fill={type:"pattern",pattern:"solid",fgColor:{argb:"1f4e79"}},n.getRow(s).height=25,s++,n.mergeCells(`A${s}:I${s}`);const D=n.getCell(`A${s}`);D.value="تقرير حوالات العمال",D.font={name:"Arial",size:11,bold:!0,color:{argb:"1f4e79"}},D.alignment={horizontal:"center",vertical:"middle"},D.fill={type:"pattern",pattern:"solid",fgColor:{argb:"f2f2f2"}},n.getRow(s).height=16,s+=2;const H=["#","التاريخ","العامل","المشروع","المبلغ","طريقة التحويل","المستلم","رقم الهاتف","ملاحظات"],_=n.getRow(s);H.forEach((d,L)=>{const S=_.getCell(L+1);S.value=d,S.font={name:"Arial",size:10,bold:!0,color:{argb:"FFFFFF"}},S.alignment={horizontal:"center",vertical:"middle",wrapText:!0},S.fill={type:"pattern",pattern:"solid",fgColor:{argb:"1f4e79"}}}),_.height=22,s++,i.forEach((d,L)=>{const S=n.getRow(s),Fe=v.find(R=>R.id===d.workerId),Pe=O.find(R=>R.id===d.projectId);[L+1,de(d.transferDate),Fe?.name||"غير معروف",Pe?.name||"غير معروف",d.amount,ue(d.transferMethod),d.recipientName,d.recipientPhone||"-",d.notes||"-"].forEach((R,Me)=>{const K=S.getCell(Me+1);K.value=R,K.font={name:"Arial",size:9},K.alignment={horizontal:"center",vertical:"middle",wrapText:!0},K.border={top:{style:"thin",color:{argb:"cccccc"}},bottom:{style:"thin",color:{argb:"cccccc"}},left:{style:"thin",color:{argb:"cccccc"}},right:{style:"thin",color:{argb:"cccccc"}}}}),n.getRow(s).height=18,s++}),s+=2,n.mergeCells(`E${s}:F${s}`);const E=n.getCell(`E${s}`);E.value="إجمالي المبالغ:",E.font={name:"Arial",size:11,bold:!0},E.alignment={horizontal:"center",vertical:"middle"},n.mergeCells(`G${s}:I${s}`);const o=n.getCell(`G${s}`);o.value=N(x.totalAmount),o.font={name:"Arial",size:11,bold:!0,color:{argb:"006600"}},o.alignment={horizontal:"center",vertical:"middle"};const g=await r.xlsx.writeBuffer(),Ae=new Date().toISOString().split("T")[0];await ft(g,`حوالات-العمال-${Ae}.xlsx`)};return t.jsxs("div",{className:"p-4 space-y-4",dir:"rtl",children:[t.jsx(Ve,{statsRows:Ne,searchValue:j,onSearchChange:te,searchPlaceholder:"ابحث عن عامل أو مستلم...",showSearch:!0,filters:Ce,filterValues:{worker:h,transferMethod:m},onFilterChange:Te,onReset:De,onRefresh:Se,isRefreshing:be,actions:[{key:"export",icon:Ue,label:"تصدير Excel",onClick:Ie,variant:"outline",disabled:i.length===0,tooltip:"تصدير إلى Excel"}]}),ye?t.jsx(fe,{children:t.jsxs(pe,{className:"text-center py-12",children:[t.jsx("div",{className:"animate-spin w-8 h-8 border-2 border-primary border-t-transparent rounded-full mx-auto mb-4"}),t.jsx("p",{className:"text-muted-foreground",children:"جاري تحميل الحوالات..."})]})}):i.length===0?t.jsx(fe,{children:t.jsxs(pe,{className:"p-8 text-center",children:[t.jsx(X,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),t.jsx("h3",{className:"text-lg font-medium text-foreground mb-2",children:"لا توجد حوالات"}),t.jsx("p",{className:"text-muted-foreground mb-4",children:j||h!=="all"||m!=="all"?"لا توجد نتائج مطابقة للفلاتر المحددة":"لم يتم إرسال أي حوالات بعد"}),t.jsxs(Z,{onClick:()=>{C(null),z(),b(!0)},className:"bg-blue-600 hover:bg-blue-700",children:[t.jsx(Oe,{className:"h-4 w-4 ml-2"}),"إرسال حولة جديدة"]})]})}):t.jsx(Ge,{columns:2,children:i.map(e=>{const r=v.find(s=>s.id===e.workerId),n=O.find(s=>s.id===e.projectId);return t.jsx(Be,{title:r?.name||"عامل غير معروف",subtitle:n?.name||"مشروع غير معروف",titleIcon:ge,badges:[{label:r?.type||"غير محدد",variant:"secondary"},{label:ue(e.transferMethod),variant:e.transferMethod==="cash"?"success":e.transferMethod==="bank"?"warning":"default"}],fields:[{label:"المبلغ",value:N(e.amount),icon:me,color:"success",emphasis:!0},{label:"التاريخ",value:de(e.transferDate),icon:Je,color:"muted"},{label:"المستلم",value:e.recipientName,icon:ge,color:"info"},{label:"الهاتف",value:e.recipientPhone||"-",icon:Xe,color:"muted"}],actions:[{icon:He,label:"تعديل",onClick:()=>ve(e),color:"blue"},{icon:Ye,label:"حذف",onClick:()=>je.mutate(e.id),color:"red"}],footer:e.notes?t.jsxs("p",{className:"text-xs text-muted-foreground",children:[t.jsx("span",{className:"font-medium",children:"ملاحظات:"})," ",e.notes]}):void 0,compact:!0},e.id)})}),t.jsx(Ze,{open:we,onOpenChange:b,children:t.jsxs(et,{className:"max-w-md",children:[t.jsxs(tt,{children:[t.jsx(rt,{children:I?"تعديل الحولة":"حولة جديدة"}),t.jsx(at,{children:I?"قم بتعديل بيانات الحولة المالية":"إنشاء حولة مالية جديدة للعامل"})]}),t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[t.jsxs("div",{className:"flex flex-col gap-1.5",children:[t.jsx(w,{children:"العامل *"}),t.jsx(st,{value:a.workerId,onValueChange:e=>c({...a,workerId:e}),workers:v,placeholder:"اختر العامل"})]}),t.jsxs("div",{className:"flex flex-col gap-1.5",children:[t.jsx(w,{children:"المشروع *"}),t.jsx(nt,{value:a.projectId,onValueChange:e=>c({...a,projectId:e}),projects:O,placeholder:"اختر المشروع"})]})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[t.jsxs("div",{children:[t.jsx(w,{children:"المبلغ (ر.ي) *"}),t.jsx(ot,{type:"number",inputMode:"decimal",step:"0.01",value:a.amount||"",onChange:e=>{const r=e.target.value;c({...a,amount:r?parseFloat(r):0})},placeholder:"0.00",autoWidth:!0,maxWidth:200,min:"0",className:"text-center arabic-numbers"})]}),t.jsxs("div",{children:[t.jsx(w,{children:"التاريخ *"}),t.jsx(lt,{value:a.transferDate,onChange:e=>c({...a,transferDate:e?it(e,"yyyy-MM-dd"):""}),className:"w-full"})]})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[t.jsxs("div",{children:[t.jsx(w,{children:"المستلم *"}),t.jsx(Q,{category:"recipientNames",value:a.recipientName,onChange:e=>c({...a,recipientName:e}),placeholder:"اسم المستلم"})]}),t.jsxs("div",{children:[t.jsx(w,{children:"طريقة التحويل *"}),t.jsxs(ct,{value:a.transferMethod,onValueChange:e=>c({...a,transferMethod:e}),children:[t.jsx(dt,{children:t.jsx(ut,{placeholder:"اختر الطريقة"})}),t.jsxs(ht,{children:[t.jsx(ee,{value:"hawaleh",children:"حولة"}),t.jsx(ee,{value:"cash",children:"نقداً"}),t.jsx(ee,{value:"bank",children:"تحويل بنكي"})]})]})]})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[t.jsxs("div",{children:[t.jsx(w,{children:"رقم الهاتف"}),t.jsx(Q,{category:"recipientPhones",value:a.recipientPhone,onChange:e=>c({...a,recipientPhone:e}),placeholder:"رقم الهاتف"})]}),t.jsxs("div",{children:[t.jsx(w,{children:"رقم التحويل"}),t.jsx(Q,{category:"workerTransferNumbers",value:a.transferNumber,onChange:e=>c({...a,transferNumber:e}),placeholder:"رقم التحويل"})]})]}),t.jsxs("div",{children:[t.jsx(w,{children:"ملاحظات"}),t.jsx(Q,{category:"workerTransferNotes",value:a.notes,onChange:e=>c({...a,notes:e}),placeholder:"ملاحظات إضافية...",autoWidth:!0,maxWidth:400})]}),t.jsxs("div",{className:"flex gap-2 pt-4",children:[t.jsxs(Z,{onClick:ke,disabled:G.isPending||B.isPending,className:"flex-1 bg-blue-600 hover:bg-blue-700",children:[G.isPending||B.isPending?t.jsx("div",{className:"animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full ml-2"}):t.jsx(X,{className:"h-4 w-4 ml-2"}),I?"تحديث الحولة":"إرسال الحولة"]}),t.jsx(Z,{type:"button",variant:"outline",onClick:()=>{b(!1),C(null),z()},children:"إلغاء"})]})]})]})})]})}export{xt as default};
