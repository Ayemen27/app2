const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-CISX-da0.js","assets/index-G-27xJUd.css"])))=>i.map(i=>d[i]);
import{u as Me,r as l,a as Ee,b as Le,c as $e,d as Re,f as H,g as J,h as qe,S as Y,D as he,U as ze,W as We,C as _e,T as Ke,j as t,i as Qe,k as Ve,l as me,m as fe,B as X,P as Oe,n as Ue,o as Ge,p as Be,q as He,s as Je,t as pe,v as Ye,w as Xe,x as Ze,y as et,z as tt,A as at,L as g,E as rt,F as st,I as nt,G as ot,H as lt,J as K,K as it,M as ct,N as dt,O as ut,Q as Z,_ as ht,R as mt,V as $}from"./index-CISX-da0.js";function bt(){Me();const[ge,w]=l.useState(!1),[S,N]=l.useState(null),[y,ee]=l.useState(""),[u,te]=l.useState("all"),[h,ae]=l.useState("all"),[I,re]=l.useState(""),[A,se]=l.useState(""),[F,ne]=l.useState(""),[we,oe]=l.useState(!1),{toast:j}=Ee(),m=Le(),{setFloatingAction:Q}=$e(),{selectedProjectId:C,getProjectIdForApi:be}=Re(),f=be()||"",R=async(e,a)=>{if(!(!a||a.trim().length<2))try{await $("/api/autocomplete","POST",{category:e,value:a.trim(),usageCount:1})}catch(n){console.error(`خطأ في حفظ قيمة الإكمال التلقائي ${e}:`,n)}},[r,c]=l.useState({workerId:"",projectId:"",amount:0,recipientName:"",recipientPhone:"",transferMethod:"hawaleh",transferNumber:"",transferDate:new Date().toISOString().split("T")[0],notes:""}),q=async()=>{const e=[];r.recipientName&&r.recipientName.trim().length>=2&&e.push(R("recipientNames",r.recipientName)),r.recipientPhone&&r.recipientPhone.trim().length>=3&&e.push(R("recipientPhones",r.recipientPhone)),r.transferNumber&&r.transferNumber.trim().length>=1&&e.push(R("workerTransferNumbers",r.transferNumber)),r.notes&&r.notes.trim().length>=2&&e.push(R("workerTransferNotes",r.notes)),e.length>0&&await Promise.all(e)},le=new URLSearchParams(window.location.search),V=le.get("edit"),ie=le.get("worker"),{data:k=[],isLoading:ft}=H({queryKey:["/api/workers"],select:e=>Array.isArray(e)?e.filter(a=>a.isActive):[]}),{data:O=[]}=H({queryKey:["/api/projects"],select:e=>Array.isArray(e)?e:[]}),{data:P=[],isLoading:xe}=H({queryKey:["/api/worker-transfers",C],queryFn:async()=>{const e=f?`/api/worker-transfers?projectId=${f}`:"/api/worker-transfers",a=await $(e,"GET");return Array.isArray(a?.data)?a.data:Array.isArray(a)?a:[]}});l.useEffect(()=>(Q(()=>{N(null),c({workerId:ie||"",projectId:"",amount:0,recipientName:"",recipientPhone:"",transferMethod:"hawaleh",transferNumber:"",transferDate:new Date().toISOString().split("T")[0],notes:""}),w(!0)},"إضافة حولة جديدة"),()=>{Q(null)}),[Q,ie]);const U=J({mutationFn:async e=>(await q(),$("/api/worker-transfers","POST",e)),onSuccess:()=>{m.refetchQueries({queryKey:["/api/worker-transfers",C]}),m.refetchQueries({queryKey:["/api/autocomplete"]}),w(!1),z(),j({title:"تم بنجاح",description:"تم إرسال الحولة بنجاح"})},onError:async e=>{await q(),m.refetchQueries({queryKey:["/api/autocomplete"]});let a="فشل في إرسال الحولة";e?.response?.data?.message?a=e.response.data.message:e?.message&&(a=e.message),j({title:"خطأ",description:a,variant:"destructive"})}}),G=J({mutationFn:async e=>(await q(),$(`/api/worker-transfers/${e.id}`,"PATCH",e.updates)),onSuccess:()=>{m.refetchQueries({queryKey:["/api/worker-transfers",C]}),m.refetchQueries({queryKey:["/api/autocomplete"]}),w(!1),N(null),z(),j({title:"تم بنجاح",description:"تم تحديث الحولة بنجاح"})},onError:async e=>{await q(),m.refetchQueries({queryKey:["/api/autocomplete"]});let a="فشل في تحديث الحولة";e?.response?.data?.message?a=e.response.data.message:e?.message&&(a=e.message),j({title:"خطأ",description:a,variant:"destructive"})}}),ye=J({mutationFn:async e=>$(`/api/worker-transfers/${e}`,"DELETE"),onSuccess:()=>{m.refetchQueries({queryKey:["/api/worker-transfers",C]}),j({title:"تم بنجاح",description:"تم حذف الحولة بنجاح"})},onError:e=>{let a="فشل في حذف الحولة";e?.response?.data?.message?a=e.response.data.message:e?.message&&(a=e.message),j({title:"خطأ",description:a,variant:"destructive"})}});l.useEffect(()=>{if(V&&P.length>0){const e=P.find(a=>a.id===V);e&&(N(e),c({workerId:e.workerId,projectId:e.projectId,amount:e.amount,recipientName:e.recipientName,recipientPhone:e.recipientPhone||"",transferMethod:e.transferMethod,transferNumber:e.transferNumber||"",transferDate:e.transferDate,notes:e.notes||""}),w(!0))}},[V,P]);const z=()=>{c({workerId:"",projectId:"",amount:0,recipientName:"",recipientPhone:"",transferMethod:"hawaleh",transferNumber:"",transferDate:new Date().toISOString().split("T")[0],notes:""})},je=()=>{if(!r.workerId||!r.projectId||!r.amount||!r.recipientName||!r.transferDate){j({title:"خطأ",description:"الرجاء ملء جميع الحقول المطلوبة",variant:"destructive"});return}S?G.mutate({id:S.id,updates:r}):U.mutate(r)},ke=e=>{N(e),c({workerId:e.workerId,projectId:e.projectId,amount:e.amount,recipientName:e.recipientName,recipientPhone:e.recipientPhone||"",transferMethod:e.transferMethod,transferNumber:e.transferNumber||"",transferDate:e.transferDate,notes:e.notes||""}),w(!0)},v=e=>`${(typeof e=="string"?parseFloat(e):e).toLocaleString("en-US")} ر.ي`,ce=e=>new Date(e).toLocaleDateString("en-GB",{year:"numeric",month:"2-digit",day:"2-digit"}),de=e=>{switch(e){case"cash":return"نقداً";case"bank":return"تحويل بنكي";case"hawaleh":return"حولة";default:return e}},i=l.useMemo(()=>{let e=[...P];if(f&&f!=="all"&&(e=e.filter(a=>a.projectId===f)),u&&u!=="all"&&(e=e.filter(a=>a.workerId===u)),h&&h!=="all"&&(e=e.filter(a=>a.transferMethod===h)),y){const a=y.toLowerCase();e=e.filter(n=>k.find(x=>x.id===n.workerId)?.name.toLowerCase().includes(a)||n.recipientName.toLowerCase().includes(a)||n.notes?.toLowerCase().includes(a))}return I&&(e=e.filter(a=>new Date(a.transferDate)>=new Date(I))),A&&(e=e.filter(a=>new Date(a.transferDate)<=new Date(A))),F&&(e=e.filter(a=>{const n=new Date(a.transferDate),s=new Date(F);return n.getFullYear()===s.getFullYear()&&n.getMonth()===s.getMonth()&&n.getDate()===s.getDate()})),e},[P,f,u,h,y,I,A,F,k]),{summary:ue,isLoading:pt}=qe(),b=l.useMemo(()=>{const e=i.reduce((o,p)=>o+(Number(p.amount)||0),0),a=i.filter(o=>o.transferMethod==="cash"),n=i.filter(o=>o.transferMethod==="bank"),s=i.filter(o=>o.transferMethod==="hawaleh"),x=a.reduce((o,p)=>o+(Number(p.amount)||0),0),D=n.reduce((o,p)=>o+(Number(p.amount)||0),0),B=s.reduce((o,p)=>o+(Number(p.amount)||0),0),W=new Set(i.map(o=>o.workerId)).size,M=f&&f!=="all"||u&&u!=="all"||h&&h!=="all"||y||I||A||F;return{totalTransfers:i.length,totalAmount:M?e:ue?.totalWorkerTransfers||e,cashAmount:x,bankAmount:D,hawalehAmount:B,uniqueWorkers:W,averageTransfer:i.length>0?e/i.length:0}},[i,ue,f,u,h,y,I,A,F]),ve=l.useMemo(()=>[{columns:3,gap:"sm",items:[{key:"totalTransfers",label:"إجمالي الحوالات",value:b.totalTransfers.toString(),icon:Y,color:"blue"},{key:"totalAmount",label:"إجمالي المبالغ",value:v(b.totalAmount),icon:he,color:"green"},{key:"uniqueWorkers",label:"عدد العمال",value:b.uniqueWorkers.toString(),icon:ze,color:"purple"},{key:"cashAmount",label:"نقداً",value:v(b.cashAmount),icon:We,color:"emerald"},{key:"bankAmount",label:"تحويل بنكي",value:v(b.bankAmount),icon:_e,color:"orange"},{key:"hawalehAmount",label:"حوالات",value:v(b.hawalehAmount),icon:Ke,color:"teal"}]}],[b,v]),Ne=l.useMemo(()=>[{key:"worker",label:"العامل",type:"select",placeholder:"اختر العامل",options:[{value:"all",label:"جميع العمال"},...k.map(e=>({value:e.id,label:`${e.name} (${e.type})`}))]},{key:"transferMethod",label:"طريقة التحويل",type:"select",placeholder:"طريقة التحويل",options:[{value:"all",label:"جميع الطرق"},{value:"cash",label:"نقداً"},{value:"bank",label:"تحويل بنكي"},{value:"hawaleh",label:"حولة"}]},{key:"dateFrom",label:"من تاريخ",type:"date",placeholder:"من تاريخ"},{key:"dateTo",label:"إلى تاريخ",type:"date",placeholder:"إلى تاريخ"},{key:"specificDate",label:"تاريخ يوم محدد",type:"date",placeholder:"تاريخ يوم محدد"}],[k]),Ce=l.useCallback((e,a)=>{e==="worker"?te(a):e==="transferMethod"?ae(a):e==="dateFrom"?re(a):e==="dateTo"?se(a):e==="specificDate"&&ne(a)},[]),De=l.useCallback(()=>{te("all"),ae("all"),ee(""),re(""),se(""),ne("")},[]),Te=l.useCallback(async()=>{oe(!0),await m.refetchQueries({queryKey:["/api/worker-transfers",C]}),oe(!1)},[m,C]),Se=async()=>{if(i.length===0)return;const e=(await ht(async()=>{const{default:d}=await import("./index-CISX-da0.js").then(E=>E.e);return{default:d}},__vite__mapDeps([0,1]))).default,a=new e.Workbook,n=a.addWorksheet("حوالات العمال");n.views=[{rightToLeft:!0}],n.pageSetup={paperSize:9,orientation:"landscape",fitToPage:!0,fitToWidth:1,fitToHeight:0,margins:{left:.2,right:.2,top:.3,bottom:.3,header:.1,footer:.1},horizontalCentered:!0,scale:80},n.columns=[{width:5},{width:12},{width:15},{width:15},{width:12},{width:12},{width:15},{width:12},{width:20}];let s=1;n.mergeCells(`A${s}:I${s}`);const x=n.getCell(`A${s}`);x.value="شركة الفتيني للمقاولات والاستشارات الهندسية",x.font={name:"Arial",size:14,bold:!0,color:{argb:"FFFFFF"}},x.alignment={horizontal:"center",vertical:"middle"},x.fill={type:"pattern",pattern:"solid",fgColor:{argb:"1f4e79"}},n.getRow(s).height=25,s++,n.mergeCells(`A${s}:I${s}`);const D=n.getCell(`A${s}`);D.value="تقرير حوالات العمال",D.font={name:"Arial",size:11,bold:!0,color:{argb:"1f4e79"}},D.alignment={horizontal:"center",vertical:"middle"},D.fill={type:"pattern",pattern:"solid",fgColor:{argb:"f2f2f2"}},n.getRow(s).height=16,s+=2;const B=["#","التاريخ","العامل","المشروع","المبلغ","طريقة التحويل","المستلم","رقم الهاتف","ملاحظات"],W=n.getRow(s);B.forEach((d,E)=>{const T=W.getCell(E+1);T.value=d,T.font={name:"Arial",size:10,bold:!0,color:{argb:"FFFFFF"}},T.alignment={horizontal:"center",vertical:"middle",wrapText:!0},T.fill={type:"pattern",pattern:"solid",fgColor:{argb:"1f4e79"}}}),W.height=22,s++,i.forEach((d,E)=>{const T=n.getRow(s),Ae=k.find(L=>L.id===d.workerId),Fe=O.find(L=>L.id===d.projectId);[E+1,ce(d.transferDate),Ae?.name||"غير معروف",Fe?.name||"غير معروف",d.amount,de(d.transferMethod),d.recipientName,d.recipientPhone||"-",d.notes||"-"].forEach((L,Pe)=>{const _=T.getCell(Pe+1);_.value=L,_.font={name:"Arial",size:9},_.alignment={horizontal:"center",vertical:"middle",wrapText:!0},_.border={top:{style:"thin",color:{argb:"cccccc"}},bottom:{style:"thin",color:{argb:"cccccc"}},left:{style:"thin",color:{argb:"cccccc"}},right:{style:"thin",color:{argb:"cccccc"}}}}),n.getRow(s).height=18,s++}),s+=2,n.mergeCells(`E${s}:F${s}`);const M=n.getCell(`E${s}`);M.value="إجمالي المبالغ:",M.font={name:"Arial",size:11,bold:!0},M.alignment={horizontal:"center",vertical:"middle"},n.mergeCells(`G${s}:I${s}`);const o=n.getCell(`G${s}`);o.value=v(b.totalAmount),o.font={name:"Arial",size:11,bold:!0,color:{argb:"006600"}},o.alignment={horizontal:"center",vertical:"middle"};const p=await a.xlsx.writeBuffer(),Ie=new Date().toISOString().split("T")[0];await mt(p,`حوالات-العمال-${Ie}.xlsx`)};return t.jsxs("div",{className:"p-4 space-y-4",dir:"rtl",children:[t.jsx(Qe,{statsRows:ve,searchValue:y,onSearchChange:ee,searchPlaceholder:"ابحث عن عامل أو مستلم...",showSearch:!0,filters:Ne,filterValues:{worker:u,transferMethod:h},onFilterChange:Ce,onReset:De,onRefresh:Te,isRefreshing:we,actions:[{key:"export",icon:Ve,label:"تصدير Excel",onClick:Se,variant:"outline",disabled:i.length===0,tooltip:"تصدير إلى Excel"}]}),xe?t.jsx(me,{children:t.jsxs(fe,{className:"text-center py-12",children:[t.jsx("div",{className:"animate-spin w-8 h-8 border-2 border-primary border-t-transparent rounded-full mx-auto mb-4"}),t.jsx("p",{className:"text-muted-foreground",children:"جاري تحميل الحوالات..."})]})}):i.length===0?t.jsx(me,{children:t.jsxs(fe,{className:"p-8 text-center",children:[t.jsx(Y,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),t.jsx("h3",{className:"text-lg font-medium text-foreground mb-2",children:"لا توجد حوالات"}),t.jsx("p",{className:"text-muted-foreground mb-4",children:y||u!=="all"||h!=="all"?"لا توجد نتائج مطابقة للفلاتر المحددة":"لم يتم إرسال أي حوالات بعد"}),t.jsxs(X,{onClick:()=>{N(null),z(),w(!0)},className:"bg-blue-600 hover:bg-blue-700",children:[t.jsx(Oe,{className:"h-4 w-4 ml-2"}),"إرسال حولة جديدة"]})]})}):t.jsx(Ue,{columns:2,children:i.map(e=>{const a=k.find(s=>s.id===e.workerId),n=O.find(s=>s.id===e.projectId);return t.jsx(Ge,{title:a?.name||"عامل غير معروف",subtitle:n?.name||"مشروع غير معروف",titleIcon:pe,badges:[{label:a?.type||"غير محدد",variant:"secondary"},{label:de(e.transferMethod),variant:e.transferMethod==="cash"?"success":e.transferMethod==="bank"?"warning":"default"}],fields:[{label:"المبلغ",value:v(e.amount),icon:he,color:"success",emphasis:!0},{label:"التاريخ",value:ce(e.transferDate),icon:Je,color:"muted"},{label:"المستلم",value:e.recipientName,icon:pe,color:"info"},{label:"الهاتف",value:e.recipientPhone||"-",icon:Ye,color:"muted"}],actions:[{icon:Be,label:"تعديل",onClick:()=>ke(e),color:"blue"},{icon:He,label:"حذف",onClick:()=>ye.mutate(e.id),color:"red"}],footer:e.notes?t.jsxs("p",{className:"text-xs text-muted-foreground",children:[t.jsx("span",{className:"font-medium",children:"ملاحظات:"})," ",e.notes]}):void 0,compact:!0},e.id)})}),t.jsx(Xe,{open:ge,onOpenChange:w,children:t.jsxs(Ze,{className:"max-w-md",children:[t.jsxs(et,{children:[t.jsx(tt,{children:S?"تعديل الحولة":"حولة جديدة"}),t.jsx(at,{children:S?"قم بتعديل بيانات الحولة المالية":"إنشاء حولة مالية جديدة للعامل"})]}),t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[t.jsxs("div",{className:"flex flex-col gap-1.5",children:[t.jsx(g,{children:"العامل *"}),t.jsx(rt,{value:r.workerId,onValueChange:e=>c({...r,workerId:e}),workers:k,placeholder:"اختر العامل"})]}),t.jsxs("div",{className:"flex flex-col gap-1.5",children:[t.jsx(g,{children:"المشروع *"}),t.jsx(st,{value:r.projectId,onValueChange:e=>c({...r,projectId:e}),projects:O,placeholder:"اختر المشروع"})]})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[t.jsxs("div",{children:[t.jsx(g,{children:"المبلغ (ر.ي) *"}),t.jsx(nt,{type:"number",inputMode:"decimal",step:"0.01",value:r.amount||"",onChange:e=>{const a=e.target.value;c({...r,amount:a?parseFloat(a):0})},placeholder:"0.00",min:"0",className:"text-center arabic-numbers"})]}),t.jsxs("div",{children:[t.jsx(g,{children:"التاريخ *"}),t.jsx(ot,{value:r.transferDate,onChange:e=>c({...r,transferDate:e?lt(e,"yyyy-MM-dd"):""}),className:"w-full"})]})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[t.jsxs("div",{children:[t.jsx(g,{children:"المستلم *"}),t.jsx(K,{category:"recipientNames",value:r.recipientName,onChange:e=>c({...r,recipientName:e}),placeholder:"اسم المستلم"})]}),t.jsxs("div",{children:[t.jsx(g,{children:"طريقة التحويل *"}),t.jsxs(it,{value:r.transferMethod,onValueChange:e=>c({...r,transferMethod:e}),children:[t.jsx(ct,{children:t.jsx(dt,{placeholder:"اختر الطريقة"})}),t.jsxs(ut,{children:[t.jsx(Z,{value:"hawaleh",children:"حولة"}),t.jsx(Z,{value:"cash",children:"نقداً"}),t.jsx(Z,{value:"bank",children:"تحويل بنكي"})]})]})]})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[t.jsxs("div",{children:[t.jsx(g,{children:"رقم الهاتف"}),t.jsx(K,{category:"recipientPhones",value:r.recipientPhone,onChange:e=>c({...r,recipientPhone:e}),placeholder:"رقم الهاتف"})]}),t.jsxs("div",{children:[t.jsx(g,{children:"رقم التحويل"}),t.jsx(K,{category:"workerTransferNumbers",value:r.transferNumber,onChange:e=>c({...r,transferNumber:e}),placeholder:"رقم التحويل"})]})]}),t.jsxs("div",{children:[t.jsx(g,{children:"ملاحظات"}),t.jsx(K,{category:"workerTransferNotes",value:r.notes,onChange:e=>c({...r,notes:e}),placeholder:"ملاحظات إضافية..."})]}),t.jsxs("div",{className:"flex gap-2 pt-4",children:[t.jsxs(X,{onClick:je,disabled:U.isPending||G.isPending,className:"flex-1 bg-blue-600 hover:bg-blue-700",children:[U.isPending||G.isPending?t.jsx("div",{className:"animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full ml-2"}):t.jsx(Y,{className:"h-4 w-4 ml-2"}),S?"تحديث الحولة":"إرسال الحولة"]}),t.jsx(X,{type:"button",variant:"outline",onClick:()=>{w(!1),N(null),z()},children:"إلغاء"})]})]})]})})]})}export{bt as default};
