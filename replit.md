# دستور عمل وكيل الذكاء الاصطناعي (AI Agent Protocol)

## القواعد الذهبية (ممنوع):
- **المراوغة أو التعميم**: الإجابات يجب أن تكون محددة، مباشرة، ومدعومة بالحقائق البرمجية.
- **المعلومات غير المؤكدة**: يمنع اختلاق معلومات أو إعطاء إجابات تخمينية. في حال عدم التأكد، يجب التصريح بذلك بوضوح مع ذكر نسبة الشك.
- **التسرع**: الدقة مقدمة على السرعة دائماً. ممنوع التسريع على حساب الجودة أو الصحة التقنية.
- **الخداع أو المجاملة**: تقديم الواقع التقني كما هو، حتى لو كان غير مريح للمستخدم.
- **استخدام أداة البحث**: يُمنع منعاً باتاً استخدام `search_codebase` لتجنب تعليق النظام.

## الالتزامات (ملزم بـ):
- **التفكير التحليلي خطوة بخطوة**: تحليل المشكلة وفهم أبعادها قبل كتابة سطر كود واحد.
- **التصريح الصريح بعدم المعرفة**: قول "لا أعرف" أو "المعلومة ناقصة" وطلبها بوضوح من المستخدم.
- **الحلول الواقعية والقابلة للتنفيذ**: اختيار الحل الأكثر استقراراً وأماناً، مع شرح أسباب الاختيار.
- **توضيح الافتراضات**: يجب التصريح بجميع الافتراضات التي بني عليها الحل قبل التنفيذ.
- **التفكير خارج الصندوق (بمنطقية)**: اقتراح حلول بديلة ذكية أو غير تقليدية عند فشل الحلول الشائعة، بشرط قابليتها للتطبيق.

## آلية اتخاذ القرار:
1. **التقييم**: دراسة الخيارات المتاحة (تقليدي، بديل، غير تقليدي).
2. **المفاضلة**: اختيار الأفضل بناءً على (التكلفة، السرعة، الاستقرار).
3. **التنفيذ**: البدء بالحل الأكثر واقعية بعد توضيح الأسباب.

---
*تم تحديث هذا البروتوكول بتاريخ 21 يناير 2026 ليكون المرجع الصارم والنهائي لسلوك الوكيل.*

## حالة المشروع الحالية (23 يناير 2026):
- تم التحقق من استقرار النظام (الخادم يعمل، قاعدة البيانات متصلة).
- تم تحليل `schema.ts` وفهم هيكلية البيانات المعقدة للمشاريع والعمال والآبار.
- الالتزام كامل بالبروتوكول الجديد في جميع عمليات التطوير.

## تحسينات الأمان في نظام الطوارئ (23 يناير 2026)
تم تحسين نظام الطوارئ وإزالة البيانات الحساسة من الكود:

### المشاكل التي تم حلها:
1. **إزالة المفاتيح المشفرة المكتوبة مباشرة (Hardcoded Keys)**
   - تم نقل `ENCRYPTION_KEY` إلى متغيرات البيئة
   - تم نقل `ENCRYPTION_SALT` إلى متغيرات البيئة
   - النظام يفشل بأمان عند عدم توفر هذه المتغيرات في بيئة الإنتاج

2. **تحسين آلية التحقق من بيانات الاعتماد**
   - استخدام `EMERGENCY_ADMIN_EMAIL` و `EMERGENCY_ADMIN_PASSWORD` من متغيرات البيئة فقط
   - بيانات الاعتماد المؤقتة محفوظة في جدول `emergencyUsers` بقاعدة البيانات
   - تشفير جميع كلمات المرور باستخدام bcrypt مع ملح قوي

3. **إضافة حماية من هجمات Brute Force**
   - نظام تحديد معدل الطلبات (Rate Limiting) مع حد أقصى 5 محاولات
   - قفل لمدة 15 دقيقة بعد تجاوز حد المحاولات
   - إعادة تعيين عداد المحاولات بعد 10 دقائق من الخمول

### ملفات تم تحديثها:
- `server/auth/crypto-utils.ts` - استخدام متغيرات البيئة للمفاتيح المشفرة
- `server/services/emergency-auth-service.ts` - خدمة مصادقة الطوارئ الجديدة
- `server/routes/modules/authRoutes.ts` - إضافة مسارات المصادقة في الطوارئ

### متغيرات البيئة المطلوبة:
```
# مفاتيح التشفير (إلزامي)
ENCRYPTION_KEY=<مفتاح عشوائي 64 حرف (hex)>
ENCRYPTION_SALT=<ملح عشوائي 32 حرف (hex)>

# بيانات المسؤول في الطوارئ (اختياري)
EMERGENCY_ADMIN_EMAIL=admin@example.com
EMERGENCY_ADMIN_PASSWORD=secure_password
```

### مسارات الطوارئ الجديدة:
1. `POST /api/auth/emergency/login` - تسجيل دخول بيانات طوارئ
2. `GET /api/auth/emergency/status` - الحصول على حالة نظام الطوارئ
3. `POST /api/auth/emergency/create-user` - إنشاء مستخدم طارئ جديد (إدارة فقط)

### ملاحظات الأمان:
- النظام يفشل بأمان في الإنتاج إذا لم تكن مفاتيح التشفير متوفرة
- جميع كلمات المرور محفوظة مشفرة باستخدام bcrypt
- لا توجد بيانات حساسة مكتوبة مباشرة في الكود
- جميع بيانات الاعتماد تأتي من متغيرات البيئة أو قاعدة البيانات
