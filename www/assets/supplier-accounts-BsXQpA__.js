const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-DB6w_xWP.js","assets/index-CgswThfB.css"])))=>i.map(i=>d[i]);
import{r as m,c as fe,d as be,a as ve,f as T,Q as b,h as Ce,U as J,W as Y,C as Ae,$ as we,a4 as N,D as X,a5 as Fe,T as q,a6 as Z,a7 as ee,a8 as te,j as c,i as Se,k as Te,o as ae,v as xe,a0 as Pe,a9 as le,l as re,m as oe,n as De,s as $e,p as je,q as ke,X as D,_ as Re,V as ze}from"./index-DB6w_xWP.js";function Qe(){const[o,I]=m.useState("all"),[A,L]=m.useState(""),[w,_]=m.useState(""),[k,K]=m.useState(""),[n,U]=m.useState("all"),[ie,W]=m.useState(!1),{setFloatingAction:R}=fe(),{selectedProjectId:$,getProjectIdForApi:Q}=be(),{toast:z}=ve();m.useEffect(()=>(R(null),()=>R(null)),[R]);const{data:B=[]}=T({queryKey:b.projects,queryFn:async()=>{try{const e=await D("/api/projects","GET");return e&&e.data&&Array.isArray(e.data)?e.data:Array.isArray(e)?e:[]}catch(e){return console.error("Error fetching projects:",e),[]}}}),{data:F=[],isLoading:Ee,error:Ne}=T({queryKey:b.suppliers,queryFn:async()=>{try{const e=await D("/api/suppliers","GET");return e&&e.data&&Array.isArray(e.data)?e.data:Array.isArray(e)?e:[]}catch(e){return console.error("Error fetching suppliers:",e),[]}},staleTime:6e4,refetchOnWindowFocus:!1}),{data:j}=T({queryKey:b.materialPurchasesDateRange,staleTime:3e5}),G=Array.isArray(F)?F.filter(e=>e.name.toLowerCase().includes(k.toLowerCase())):[],{data:s=[],isLoading:ne}=T({queryKey:b.materialPurchasesFiltered($,o,A,w,n),queryFn:async()=>{const e=new URLSearchParams;o&&o!=="all"&&e.append("supplierId",o);const r=Q();if(r&&e.append("projectId",r),A&&e.append("dateFrom",A),w&&e.append("dateTo",w),n&&n!=="all"){const a=n==="أجل"?"آجل":n;e.append("purchaseType",a)}try{const a=await D(`/api/material-purchases?${e.toString()}`),t=a.data||a||[];let d=Array.isArray(t)?t:[];if(n&&n!=="all"){const f=n==="أجل"?"آجل":n;d=d.filter(C=>{const S=C.purchaseType?.replace(/['"]/g,"")||"";return S===f||f==="آجل"&&(S==="أجل"||S==="آجل")})}return d}catch(a){return console.error("خطأ في جلب المشتريات:",a),[]}},refetchOnWindowFocus:!1,staleTime:3e4}),{data:qe}=T({queryKey:b.supplierStatistics,queryFn:async()=>({totalSuppliers:0,totalCashPurchases:"0",totalCreditPurchases:"0",totalDebt:"0",totalPaid:"0",remainingDebt:"0",activeSuppliers:0}),enabled:!1}),{data:Ie}=T({queryKey:b.supplierStatisticsFiltered($,o,A,w,n),queryFn:async()=>{const e=new URLSearchParams;o&&o!=="all"&&e.append("supplierId",o);const r=Q();if(r&&e.append("projectId",r),A&&e.append("dateFrom",A),w&&e.append("dateTo",w),n&&n!=="all"){const a=n==="أجل"?"آجل":n;e.append("purchaseType",a)}try{const a=await D(`/api/suppliers/statistics?${e.toString()}`);return a.data||a||{totalSuppliers:0,totalCashPurchases:"0",totalCreditPurchases:"0",totalDebt:"0",totalPaid:"0",remainingDebt:"0",activeSuppliers:0}}catch{return{totalSuppliers:0,totalCashPurchases:"0",totalCreditPurchases:"0",totalDebt:"0",totalPaid:"0",remainingDebt:"0",activeSuppliers:0}}},refetchOnWindowFocus:!1,staleTime:3e4}),g=o&&o!=="all"?F.find(e=>e.id===o):null,h=Array.isArray(s)?s.reduce((e,r)=>(e.totalAmount+=parseFloat(r.totalAmount||"0"),e.paidAmount+=parseFloat(r.paidAmount||"0"),e.remainingAmount+=parseFloat(r.remainingAmount||"0"),e),{totalAmount:0,paidAmount:0,remainingAmount:0}):{totalAmount:0,paidAmount:0,remainingAmount:0},{summary:x,isLoading:Le}=Ce(),M=o&&o!=="all"||$&&$!=="all"||A||w||n&&n!=="all"||k,v={totalSuppliers:F.length,totalCashPurchases:M?Array.isArray(s)?s.filter(e=>e.purchaseType==="نقد").reduce((e,r)=>e+parseFloat(r.totalAmount||"0"),0).toString():"0":(x?.totalCashMaterials||"0").toString(),totalCreditPurchases:M?Array.isArray(s)?s.filter(e=>e.purchaseType==="آجل"||e.purchaseType==="أجل").reduce((e,r)=>e+parseFloat(r.totalAmount||"0"),0).toString():"0":(x?.totalCreditMaterials||"0").toString(),totalDebt:x?.totalSuppliersDebt||"0",totalPaid:x?.totalSuppliersPaid||"0",remainingDebt:x?.totalSuppliersDebt||"0",activeSuppliers:F.filter(e=>parseFloat(e.totalDebt||"0")>0).length,totalPurchases:Array.isArray(s)?s.length:0},O=e=>new Date(e).toLocaleDateString("en-GB",{year:"numeric",month:"2-digit",day:"2-digit"}),i=e=>(typeof e=="string"?parseFloat(e):e).toLocaleString("en-US")+" ريال",se=async()=>{if(s.length===0)return;const e=(await Re(async()=>{const{default:l}=await import("./index-DB6w_xWP.js").then(p=>p.e);return{default:l}},__vite__mapDeps([0,1]))).default,r=new e.Workbook,a=r.addWorksheet("كشف حساب المورد");a.views=[{rightToLeft:!0}],a.pageSetup={paperSize:9,orientation:"portrait",fitToPage:!0,fitToWidth:1,fitToHeight:0,margins:{left:.2,right:.2,top:.3,bottom:.3,header:.1,footer:.1},horizontalCentered:!0,scale:80},a.columns=[{width:3},{width:9},{width:12},{width:16},{width:20},{width:6},{width:9},{width:11},{width:8},{width:9},{width:9},{width:8}];let t=1;a.mergeCells(`A${t}:L${t}`);const d=a.getCell(`A${t}`);d.value="الفتيني للمقاولات العامة والاستشارات الهندسية",d.font={name:"Arial",size:14,bold:!0,color:{argb:"FFFFFF"}},d.alignment={horizontal:"center",vertical:"middle"},d.fill={type:"pattern",pattern:"solid",fgColor:{argb:"1f4e79"}},a.getRow(t).height=25,t++,a.mergeCells(`A${t}:L${t}`);const f=a.getCell(`A${t}`);if(f.value="كشف حساب المورد - تقرير مفصل",f.font={name:"Arial",size:11,bold:!0,color:{argb:"1f4e79"}},f.alignment={horizontal:"center",vertical:"middle"},f.fill={type:"pattern",pattern:"solid",fgColor:{argb:"f2f2f2"}},a.getRow(t).height=16,t+=2,g){a.mergeCells(`A${t}:L${t}`);const l=a.getCell(`A${t}`);l.value="بيانات المورد",l.font={name:"Arial",size:11,bold:!0,color:{argb:"FFFFFF"}},l.alignment={horizontal:"center",vertical:"middle"},l.fill={type:"pattern",pattern:"solid",fgColor:{argb:"2e75b6"}},a.getRow(t).height=22,t++,[["اسم المورد",g.name,"رقم الهاتف",g.phone||"غير محدد"],["شخص الاتصال",g.contactPerson||"غير محدد","العنوان",g.address||"غير محدد"]].forEach(y=>{const u=a.getRow(t);a.mergeCells(`A${t}:B${t}`),u.getCell(1).value=y[0],u.getCell(1).font={name:"Arial",size:9,bold:!0},u.getCell(1).alignment={horizontal:"center",vertical:"middle"},a.mergeCells(`C${t}:F${t}`),u.getCell(3).value=y[1],u.getCell(3).font={name:"Arial",size:9},u.getCell(3).alignment={horizontal:"center",vertical:"middle"},a.mergeCells(`G${t}:H${t}`),u.getCell(7).value=y[2],u.getCell(7).font={name:"Arial",size:9,bold:!0},u.getCell(7).alignment={horizontal:"center",vertical:"middle"},a.mergeCells(`I${t}:L${t}`),u.getCell(9).value=y[3],u.getCell(9).font={name:"Arial",size:9},u.getCell(9).alignment={horizontal:"center",vertical:"middle"},a.getRow(t).height=18,t++}),t+=1}const C=["#","التاريخ","رقم الفاتورة","اسم المشروع","المادة","الكمية","سعر الوحدة","المبلغ الإجمالي","نوع الدفع","المدفوع","المتبقي","الحالة"],S=a.getRow(t);C.forEach((l,p)=>{const y=S.getCell(p+1);y.value=l,y.font={name:"Arial",size:9,bold:!0,color:{argb:"FFFFFF"}},y.alignment={horizontal:"center",vertical:"middle",wrapText:!0},y.fill={type:"pattern",pattern:"solid",fgColor:{argb:"1f4e79"}}}),S.height=20,t++,s.forEach((l,p)=>{const y=a.getRow(t),u=B.find(E=>E.id===l.projectId)?.name||"غير محدد",ye=l.materialName||"غير محدد";[p+1,O(l.invoiceDate||l.purchaseDate),l.invoiceNumber||"-",u,ye,Number(l.quantity),parseFloat(l.unitPrice),parseFloat(l.totalAmount),l.purchaseType,parseFloat(l.paidAmount||"0"),parseFloat(l.remainingAmount||"0"),parseFloat(l.remainingAmount||"0")===0?"مسدد":"مؤجل"].forEach((E,V)=>{const P=y.getCell(V+1);P.value=E,P.font={name:"Arial",size:8},P.alignment={horizontal:"center",vertical:"middle",wrapText:!0},P.border={top:{style:"thin",color:{argb:"cccccc"}},bottom:{style:"thin",color:{argb:"cccccc"}},left:{style:"thin",color:{argb:"cccccc"}},right:{style:"thin",color:{argb:"cccccc"}}},[1,6,7,8,10,11].includes(V+1)&&(P.numFmt="#,##0.00")}),a.getRow(t).height=18,t++}),t+=2,[["إجمالي المشتريات",i(h.totalAmount)],["إجمالي المدفوع",i(h.paidAmount)],["إجمالي المتبقي",i(h.remainingAmount)]].forEach(l=>{const p=a.getRow(t);a.mergeCells(`H${t}:I${t}`),p.getCell(8).value=l[0],p.getCell(8).font={name:"Arial",size:10,bold:!0},p.getCell(8).alignment={horizontal:"center",vertical:"middle"},a.mergeCells(`J${t}:L${t}`),p.getCell(10).value=l[1],p.getCell(10).font={name:"Arial",size:10,bold:!0},p.getCell(10).alignment={horizontal:"center",vertical:"middle"},a.getRow(t).height=20,t++});const ge=await r.xlsx.writeBuffer(),H=new Date().toISOString().split("T")[0],he=g?`كشف-حساب-${g.name}-${H}.xlsx`:`كشف-حساب-جميع-الموردين-${H}.xlsx`;await ze(ge,he)||z({title:"تعذر التنزيل",description:"تم تجهيز الملف لكن فشل التنزيل. حاول مرة أخرى.",variant:"destructive"})},ce=m.useCallback(()=>{I("all"),L(""),_(""),K(""),U("all")},[]),ue=m.useCallback(async()=>{W(!0),await new Promise(e=>setTimeout(e,500)),W(!1)},[]);m.useEffect(()=>{o&&j&&(L(j.minDate),_(j.maxDate))},[o,j]);const de=m.useMemo(()=>[{columns:3,gap:"sm",items:[{key:"totalSuppliers",label:"إجمالي الموردين",value:v.totalSuppliers.toString(),icon:J,color:"blue"},{key:"cashPurchases",label:"المشتريات النقدية",value:i(v.totalCashPurchases),icon:Y,color:"green"},{key:"creditPurchases",label:"المشتريات الآجلة",value:i(v.totalCreditPurchases),icon:Ae,color:"orange"},{key:"remainingDebt",label:"إجمالي المديونية",value:i(v.remainingDebt),icon:we,color:"red"},{key:"activeSuppliers",label:"موردين نشطين",value:v.activeSuppliers.toString(),icon:N,color:"purple"},{key:"totalPaid",label:"إجمالي المدفوع",value:i(v.totalPaid),icon:X,color:"emerald"}]},...o&&o!=="all"?[{columns:3,gap:"sm",items:[{key:"supplierTotal",label:"مشتريات المورد",value:i(h.totalAmount),icon:Fe,color:"purple"},{key:"supplierPaid",label:"المدفوع للمورد",value:i(h.paidAmount),icon:q,color:"green"},{key:"supplierRemaining",label:"المتبقي على المورد",value:i(h.remainingAmount),icon:Z,color:"red"},{key:"supplierInvoices",label:"عدد الفواتير",value:s.length.toString(),icon:ee,color:"blue"},{key:"averageInvoice",label:"متوسط الفاتورة",value:i(s.length>0?h.totalAmount/s.length:0),icon:te,color:"amber"},{key:"paymentProgress",label:"نسبة السداد",value:h.totalAmount>0?`${(h.paidAmount/h.totalAmount*100).toFixed(1)}%`:"0%",icon:q,color:"teal"}]}]:[]],[v,h,s.length,o,i]),pe=m.useMemo(()=>[{key:"supplier",label:"المورد",type:"select",placeholder:"اختر المورد",options:[{value:"all",label:"جميع الموردين"},...G.map(e=>({value:e.id,label:`${e.name}${parseFloat(e.totalDebt)>0?` - ${i(e.totalDebt)}`:""}`}))]},{key:"paymentType",label:"نوع الدفع",type:"select",placeholder:"نوع الدفع",options:[{value:"all",label:"جميع الأنواع"},{value:"نقد",label:"نقد"},{value:"أجل",label:"أجل"}]}],[G,i]),me=m.useCallback((e,r)=>{e==="supplier"?I(r):e==="paymentType"&&U(r)},[]);return c.jsxs("div",{className:"p-4 space-y-4",dir:"rtl",children:[c.jsx(Se,{statsRows:de,searchValue:k,onSearchChange:K,searchPlaceholder:"ابحث عن مورد...",showSearch:!0,filters:pe,filterValues:{supplier:o,paymentType:n},onFilterChange:me,onReset:ce,onRefresh:ue,isRefreshing:ie,actions:[{key:"export",label:"تصدير",icon:Te,onClick:se,disabled:s.length===0}]}),g&&c.jsx(ae,{title:g.name,subtitle:"معلومات المورد",titleIcon:le,headerColor:"#3b82f6",fields:[{label:"المسؤول",value:g.contactPerson||"غير محدد",icon:J,color:"default"},{label:"الهاتف",value:g.phone||"غير محدد",icon:xe,color:"info"},{label:"العنوان",value:g.address||"غير محدد",icon:Pe,color:"default"},{label:"المديونية",value:i(v.remainingDebt),icon:Y,color:"danger",emphasis:!0}],compact:!0}),c.jsx("div",{className:"space-y-3",children:ne?c.jsx(re,{children:c.jsxs(oe,{className:"text-center py-12",children:[c.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"}),c.jsx("p",{className:"text-gray-600 mt-2",children:"جاري تحميل البيانات..."})]})}):s.length===0?c.jsx(re,{children:c.jsxs(oe,{className:"text-center py-12",children:[c.jsx(te,{className:"w-12 h-12 text-gray-400 mx-auto"}),c.jsx("p",{className:"text-gray-500 text-lg mt-2",children:"لا توجد مشتريات"}),c.jsx("p",{className:"text-gray-400 text-sm",children:"جرب تغيير فلاتر البحث أو أضف مشتريات جديدة"})]})}):c.jsx(De,{columns:2,children:s.map(e=>{const r=B.find(C=>C.id===e.projectId)?.name||"غير محدد",a=e.materialName||"غير محدد",t=e.supplierName||F.find(C=>C.id===e.supplierId)?.name||"غير محدد",d=parseFloat(e.remainingAmount||"0"),f=e.invoiceDate||e.purchaseDate;return c.jsx(ae,{title:a,subtitle:r,titleIcon:N,headerColor:d===0?"#22c55e":e.purchaseType==="نقد"?"#3b82f6":"#ef4444",badges:[{label:d===0?"مسدد":"مؤجل",variant:d===0?"success":"destructive"},{label:e.purchaseType,variant:e.purchaseType==="نقد"?"default":"warning"}],actions:[{icon:je,label:"تعديل",onClick:()=>{window.location.href=`/material-purchase?edit=${e.id}`},color:"blue"},{icon:ke,label:"حذف",onClick:async()=>{if(confirm("هل أنت متأكد من حذف هذه المشترى؟"))try{await D(`/api/material-purchases/${e.id}`,"DELETE"),await queryClient.invalidateQueries({queryKey:b.materialPurchasesFiltered()}),await queryClient.invalidateQueries({queryKey:b.suppliers}),await queryClient.invalidateQueries({queryKey:b.supplierStatistics}),z({title:"✅ تم الحذف",description:"تم حذف المشترى بنجاح"})}catch{z({title:"❌ خطأ",description:"فشل حذف المشترى",variant:"destructive"})}},color:"red"}],fields:[{label:"المورد",value:t,icon:le,color:"info"},{label:"رقم الفاتورة",value:e.invoiceNumber||"بدون رقم",icon:ee,color:"default"},{label:"التاريخ",value:O(f),icon:$e,color:"muted"},{label:"الكمية",value:`${e.quantity} × ${i(e.unitPrice)}`,icon:N,color:"default"},{label:"المبلغ الإجمالي",value:i(e.totalAmount),icon:X,color:"info",emphasis:!0},{label:"المدفوع",value:i(e.purchaseType==="نقد"?e.totalAmount:e.paidAmount||"0"),icon:q,color:"success"},{label:"المتبقي",value:i(e.purchaseType==="نقد"?0:e.remainingAmount||"0"),icon:Z,color:(e.purchaseType==="نقد"?0:d)>0?"danger":"success",emphasis:!0}],footer:e.notes?c.jsx("div",{className:"p-2 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded text-xs",children:c.jsx("p",{className:"line-clamp-2 text-amber-800 dark:text-amber-200",children:e.notes})}):void 0,compact:!0},e.id)})})})]})}export{Qe as default};
