
# 🚀 دليل ترحيل البيانات من Supabase

هذا الدليل يوضح كيفية ترحيل البيانات من قاعدة بيانات Supabase القديمة إلى قاعدة البيانات الخارجية الجديدة.

## 📋 المتطلبات المسبقة

### 1. تثبيت المكتبات المطلوبة
```bash
npm install pg @types/pg dotenv
```

### 2. إعداد متغيرات البيئة
قم بإنشاء ملف `.env.migration` أو تعديل الملف الموجود:

```env
# قاعدة البيانات القديمة (Supabase)
SUPABASE_DATABASE_URL=postgresql://postgres:كلمة_المرور@رابط_سوبابيس:5432/postgres?sslmode=require

# قاعدة البيانات الجديدة (موجودة بالفعل في .env)
# DATABASE_URL=postgresql://app2data:Ay**--772283228@93.127.142.144:5432/app2data?sslmode=require
```

### 3. الحصول على معلومات Supabase
1. اذهب إلى لوحة تحكم Supabase
2. اختر مشروعك
3. اذهب إلى Settings → Database
4. انسخ Connection String وضعه في `SUPABASE_DATABASE_URL`

## 🔧 طريقة التشغيل

### الطريقة الأولى: التشغيل المباشر
```bash
npx tsx migrate-data-from-supabase.ts
```

### الطريقة الثانية: استخدام المدير المساعد
```bash
npx tsx run-migration.ts
```

## 📊 الجداول المشمولة في الترحيل

- ✅ المستخدمين (users)
- ✅ المشاريع (projects)
- ✅ العمال (workers)
- ✅ أنواع العمال (worker_types)
- ✅ الموردين (suppliers)
- ✅ المواد (materials)
- ✅ تحويلات العهدة (fund_transfers)
- ✅ حضور العمال (worker_attendance)
- ✅ شراء المواد (material_purchases)
- ✅ مدفوعات الموردين (supplier_payments)
- ✅ مصروفات المواصلات (transportation_expenses)
- ✅ حوالات العمال (worker_transfers)
- ✅ أرصدة العمال (worker_balances)
- ✅ نثريات العمال (worker_misc_expenses)
- ✅ ملخص المصروفات اليومية (daily_expense_summaries)
- ✅ بيانات الإكمال التلقائي (autocomplete_data)
- ✅ إعدادات الطباعة (print_settings)
- ✅ تحويلات أموال المشاريع (project_fund_transfers)
- ✅ قوالب التقارير (report_templates)

## 🛡️ ميزات الأمان والحماية

### معالجة الأخطاء
- ✅ التعامل مع الأخطاء برفق دون إيقاف العملية
- ✅ تسجيل مفصل لكل خطوة
- ✅ إحصائيات شاملة للنتائج

### تنظيف البيانات
- ✅ تحويل التواريخ تلقائياً
- ✅ معالجة القيم الفارغة
- ✅ تحويل أنواع البيانات
- ✅ معالجة البيانات المكررة

### مراقبة التقدم
- ✅ عرض التقدم كل 100 سجل
- ✅ إحصائيات مفصلة لكل جدول
- ✅ تقرير نهائي شامل

## 🔍 استكشاف الأخطاء

### خطأ في الاتصال
```
❌ فشل الاتصال بقاعدة البيانات
```
**الحل:** تحقق من:
- صحة رابط قاعدة البيانات
- كلمة المرور
- إعدادات الشبكة والجدار الناري

### جدول غير موجود
```
⚠️ الجدول table_name غير موجود
```
**الحل:** 
- تحقق من أن الجدول موجود في قاعدة البيانات المصدر
- تأكد من إنشاء الجداول في قاعدة البيانات الهدف

### أعمدة غير متطابقة
```
⚠️ لا توجد أعمدة متطابقة للجدول
```
**الحل:**
- قارن بنية الجداول بين قاعدتي البيانات
- تأكد من تطابق أسماء الأعمدة

## 📈 مراقبة النتائج

بعد انتهاء الترحيل، ستحصل على تقرير مثل:
```
📊 إحصائيات الترحيل النهائية:
   📈 إجمالي الجداول: 19
   ✅ نجح: 17
   ❌ فشل: 1
   ⏭️ تم تجاهله: 1
```

## 🔄 إعادة التشغيل

يمكنك تشغيل السكربت عدة مرات بأمان:
- البيانات المكررة لن يتم إدخالها مرة أخرى
- العملية ستتجاهل الأخطاء البسيطة
- كل تشغيل سيحدث البيانات الجديدة فقط

## 🆘 طلب المساعدة

إذا واجهت مشاكل:
1. تحقق من سجلات الأخطاء في الكونسول
2. تأكد من إعدادات قاعدة البيانات
3. تحقق من صحة متغيرات البيئة
4. اختبر الاتصال بكلا قاعدتي البيانات منفصلتين
