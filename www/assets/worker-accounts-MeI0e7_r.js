const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-B0UDlDbI.js","assets/index-Df719D_k.css"])))=>i.map(i=>d[i]);
import{u as Pe,r as l,a as Me,b as Ee,c as Le,d as Re,f as H,g as Y,h as $e,S as J,D as me,U as We,W as qe,C as ze,T as _e,Q as u,j as t,i as Ke,k as Qe,l as fe,m as pe,B as X,P as Ve,n as Ue,o as Oe,p as Ge,q as Be,s as He,t as ge,v as Ye,w as Je,x as Xe,y as Ze,z as et,A as tt,L as w,E as at,F as rt,I as st,G as nt,H as ot,J as _,K as lt,M as it,N as ct,O as dt,R as Z,_ as ut,V as ht,X as $}from"./index-B0UDlDbI.js";function wt(){Pe();const[we,b]=l.useState(!1),[A,C]=l.useState(null),[j,ee]=l.useState(""),[h,te]=l.useState("all"),[m,ae]=l.useState("all"),[F,re]=l.useState(""),[P,se]=l.useState(""),[M,ne]=l.useState(""),[be,oe]=l.useState(!1),{toast:k}=Me(),f=Ee(),{setFloatingAction:K}=Le(),{selectedProjectId:D,getProjectIdForApi:xe}=Re(),p=xe()||"",W=async(e,a)=>{if(!(!a||a.trim().length<2))try{await $("/api/autocomplete","POST",{category:e,value:a.trim(),usageCount:1})}catch(s){console.error(`خطأ في حفظ قيمة الإكمال التلقائي ${e}:`,s)}},[r,c]=l.useState({workerId:"",projectId:"",amount:0,recipientName:"",recipientPhone:"",transferMethod:"hawaleh",transferNumber:"",transferDate:new Date().toISOString().split("T")[0],notes:""}),q=async()=>{const e=[];r.recipientName&&r.recipientName.trim().length>=2&&e.push(W("recipientNames",r.recipientName)),r.recipientPhone&&r.recipientPhone.trim().length>=3&&e.push(W("recipientPhones",r.recipientPhone)),r.transferNumber&&r.transferNumber.trim().length>=1&&e.push(W("workerTransferNumbers",r.transferNumber)),r.notes&&r.notes.trim().length>=2&&e.push(W("workerTransferNotes",r.notes)),e.length>0&&await Promise.all(e)},le=new URLSearchParams(window.location.search),Q=le.get("edit"),ie=le.get("worker"),{data:v=[],isLoading:mt}=H({queryKey:u.workers,select:e=>Array.isArray(e)?e.filter(a=>a.isActive):[]}),{data:V=[]}=H({queryKey:u.projects,select:e=>Array.isArray(e)?e:[]}),{data:E=[],isLoading:ye}=H({queryKey:u.workerTransfers(D),queryFn:async()=>{const e=p?`/api/worker-transfers?projectId=${p}`:"/api/worker-transfers",a=await $(e,"GET");return Array.isArray(a?.data)?a.data:Array.isArray(a)?a:[]}});l.useEffect(()=>(K(()=>{C(null),c({workerId:ie||"",projectId:"",amount:0,recipientName:"",recipientPhone:"",transferMethod:"hawaleh",transferNumber:"",transferDate:new Date().toISOString().split("T")[0],notes:""}),b(!0)},"إضافة حولة جديدة"),()=>{K(null)}),[K,ie]);const U=Y({mutationFn:async e=>(await q(),$("/api/worker-transfers","POST",e)),onSuccess:()=>{f.refetchQueries({queryKey:u.workerTransfers(D)}),f.refetchQueries({queryKey:u.autocomplete}),b(!1),z(),k({title:"تم بنجاح",description:"تم إرسال الحولة بنجاح"})},onError:async e=>{await q(),f.refetchQueries({queryKey:u.autocomplete});let a="فشل في إرسال الحولة";e?.response?.data?.message?a=e.response.data.message:e?.message&&(a=e.message),k({title:"خطأ",description:a,variant:"destructive"})}}),O=Y({mutationFn:async e=>(await q(),$(`/api/worker-transfers/${e.id}`,"PATCH",e.updates)),onSuccess:()=>{f.refetchQueries({queryKey:u.workerTransfers(D)}),f.refetchQueries({queryKey:u.autocomplete}),b(!1),C(null),z(),k({title:"تم بنجاح",description:"تم تحديث الحولة بنجاح"})},onError:async e=>{await q(),f.refetchQueries({queryKey:u.autocomplete});let a="فشل في تحديث الحولة";e?.response?.data?.message?a=e.response.data.message:e?.message&&(a=e.message),k({title:"خطأ",description:a,variant:"destructive"})}}),je=Y({mutationFn:async e=>$(`/api/worker-transfers/${e}`,"DELETE"),onSuccess:()=>{f.refetchQueries({queryKey:u.workerTransfers(D)}),k({title:"تم بنجاح",description:"تم حذف الحولة بنجاح"})},onError:e=>{let a="فشل في حذف الحولة";e?.response?.data?.message?a=e.response.data.message:e?.message&&(a=e.message),k({title:"خطأ",description:a,variant:"destructive"})}});l.useEffect(()=>{if(Q&&E.length>0){const e=E.find(a=>a.id===Q);e&&(C(e),c({workerId:e.workerId,projectId:e.projectId,amount:e.amount,recipientName:e.recipientName,recipientPhone:e.recipientPhone||"",transferMethod:e.transferMethod,transferNumber:e.transferNumber||"",transferDate:e.transferDate,notes:e.notes||""}),b(!0))}},[Q,E]);const z=()=>{c({workerId:"",projectId:"",amount:0,recipientName:"",recipientPhone:"",transferMethod:"hawaleh",transferNumber:"",transferDate:new Date().toISOString().split("T")[0],notes:""})},ke=()=>{if(!r.workerId||!r.projectId||!r.amount||!r.recipientName||!r.transferDate){k({title:"خطأ",description:"الرجاء ملء جميع الحقول المطلوبة",variant:"destructive"});return}A?O.mutate({id:A.id,updates:r}):U.mutate(r)},ve=e=>{C(e),c({workerId:e.workerId,projectId:e.projectId,amount:e.amount,recipientName:e.recipientName,recipientPhone:e.recipientPhone||"",transferMethod:e.transferMethod,transferNumber:e.transferNumber||"",transferDate:e.transferDate,notes:e.notes||""}),b(!0)},T=e=>`${(typeof e=="string"?parseFloat(e):e).toLocaleString("en-US")} ر.ي`,ce=e=>new Date(e).toLocaleDateString("en-GB",{year:"numeric",month:"2-digit",day:"2-digit"}),de=e=>{switch(e){case"cash":return"نقداً";case"bank":return"تحويل بنكي";case"hawaleh":return"حولة";default:return e}},i=l.useMemo(()=>{let e=[...E];if(p&&p!=="all"&&(e=e.filter(a=>a.projectId===p)),h&&h!=="all"&&(e=e.filter(a=>a.workerId===h)),m&&m!=="all"&&(e=e.filter(a=>a.transferMethod===m)),j){const a=j.toLowerCase();e=e.filter(s=>v.find(y=>y.id===s.workerId)?.name.toLowerCase().includes(a)||s.recipientName.toLowerCase().includes(a)||s.notes?.toLowerCase().includes(a))}return F&&(e=e.filter(a=>new Date(a.transferDate)>=new Date(F))),P&&(e=e.filter(a=>new Date(a.transferDate)<=new Date(P))),M&&(e=e.filter(a=>{const s=new Date(a.transferDate),n=new Date(M);return s.getFullYear()===n.getFullYear()&&s.getMonth()===n.getMonth()&&s.getDate()===n.getDate()})),e},[E,p,h,m,j,F,P,M,v]),{summary:ue,isLoading:ft}=$e(),x=l.useMemo(()=>{const e=i.reduce((o,g)=>o+(Number(g.amount)||0),0),a=i.filter(o=>o.transferMethod==="cash"),s=i.filter(o=>o.transferMethod==="bank"),n=i.filter(o=>o.transferMethod==="hawaleh"),y=a.reduce((o,g)=>o+(Number(g.amount)||0),0),S=s.reduce((o,g)=>o+(Number(g.amount)||0),0),G=n.reduce((o,g)=>o+(Number(g.amount)||0),0),B=new Set(i.map(o=>o.workerId)).size,L=p&&p!=="all"||h&&h!=="all"||m&&m!=="all"||j||F||P||M;return{totalTransfers:i.length,totalAmount:L?e:ue?.totalWorkerTransfers||e,cashAmount:y,bankAmount:S,hawalehAmount:G,uniqueWorkers:B,averageTransfer:i.length>0?e/i.length:0}},[i,ue,p,h,m,j,F,P,M]),Ne=l.useMemo(()=>[{columns:3,gap:"sm",items:[{key:"totalTransfers",label:"إجمالي الحوالات",value:x.totalTransfers.toString(),icon:J,color:"blue"},{key:"totalAmount",label:"إجمالي المبالغ",value:T(x.totalAmount),icon:me,color:"green"},{key:"uniqueWorkers",label:"عدد العمال",value:x.uniqueWorkers.toString(),icon:We,color:"purple"},{key:"cashAmount",label:"نقداً",value:T(x.cashAmount),icon:qe,color:"emerald"},{key:"bankAmount",label:"تحويل بنكي",value:T(x.bankAmount),icon:ze,color:"orange"},{key:"hawalehAmount",label:"حوالات",value:T(x.hawalehAmount),icon:_e,color:"teal"}]}],[x,T]),Ce=l.useMemo(()=>[{key:"worker",label:"العامل",type:"select",placeholder:"اختر العامل",options:[{value:"all",label:"جميع العمال"},...v.map(e=>({value:e.id,label:`${e.name} (${e.type})`}))]},{key:"transferMethod",label:"طريقة التحويل",type:"select",placeholder:"طريقة التحويل",options:[{value:"all",label:"جميع الطرق"},{value:"cash",label:"نقداً"},{value:"bank",label:"تحويل بنكي"},{value:"hawaleh",label:"حولة"}]},{key:"dateFrom",label:"من تاريخ",type:"date",placeholder:"من تاريخ"},{key:"dateTo",label:"إلى تاريخ",type:"date",placeholder:"إلى تاريخ"},{key:"specificDate",label:"تاريخ يوم محدد",type:"date",placeholder:"تاريخ يوم محدد"}],[v]),De=l.useCallback((e,a)=>{e==="worker"?te(a):e==="transferMethod"?ae(a):e==="dateFrom"?re(a):e==="dateTo"?se(a):e==="specificDate"&&ne(a)},[]),Te=l.useCallback(()=>{te("all"),ae("all"),ee(""),re(""),se(""),ne("")},[]),Se=l.useCallback(async()=>{oe(!0),await f.refetchQueries({queryKey:u.workerTransfers(D)}),oe(!1)},[f,D]),Ie=async()=>{if(i.length===0)return;const e=(await ut(async()=>{const{default:d}=await import("./index-B0UDlDbI.js").then(R=>R.e);return{default:d}},__vite__mapDeps([0,1]))).default,a=new e.Workbook,s=a.addWorksheet("حوالات العمال");s.views=[{rightToLeft:!0}],s.pageSetup={paperSize:9,orientation:"landscape",fitToPage:!0,fitToWidth:1,fitToHeight:0,margins:{left:.2,right:.2,top:.3,bottom:.3,header:.1,footer:.1},horizontalCentered:!0,scale:80},s.columns=[{width:5},{width:12},{width:15},{width:15},{width:12},{width:12},{width:15},{width:12},{width:20}];let n=1;s.mergeCells(`A${n}:I${n}`);const y=s.getCell(`A${n}`);y.value="الفتيني للمقاولات العامة والاستشارات الهندسية",y.font={name:"Arial",size:14,bold:!0,color:{argb:"FFFFFF"}},y.alignment={horizontal:"center",vertical:"middle"},y.fill={type:"pattern",pattern:"solid",fgColor:{argb:"1f4e79"}},s.getRow(n).height=25,n++,s.mergeCells(`A${n}:I${n}`);const S=s.getCell(`A${n}`);S.value="تقرير حوالات العمال",S.font={name:"Arial",size:11,bold:!0,color:{argb:"1f4e79"}},S.alignment={horizontal:"center",vertical:"middle"},S.fill={type:"pattern",pattern:"solid",fgColor:{argb:"f2f2f2"}},s.getRow(n).height=16,n+=2;const G=["#","التاريخ","العامل","المشروع","المبلغ","طريقة التحويل","المستلم","رقم الهاتف","ملاحظات"],B=s.getRow(n);G.forEach((d,R)=>{const I=B.getCell(R+1);I.value=d,I.font={name:"Arial",size:10,bold:!0,color:{argb:"FFFFFF"}},I.alignment={horizontal:"center",vertical:"middle",wrapText:!0},I.fill={type:"pattern",pattern:"solid",fgColor:{argb:"1f4e79"}}}),i.forEach((d,R)=>{const I=v.find(N=>N.id===d.workerId),Fe=V.find(N=>N.id===d.projectId),he=s.addRow([R+1,ce(d.transferDate),I?.name||"غير معروف",Fe?.name||"غير معروف",Number(d.amount),de(d.transferMethod),d.recipientName,d.recipientPhone||"-",d.notes||"-"]);he.eachCell(N=>{N.font={name:"Arial",size:9},N.alignment={horizontal:"center",vertical:"middle"},N.border={top:{style:"thin"},left:{style:"thin"},bottom:{style:"thin"},right:{style:"thin"}}}),he.getCell(5).numFmt="#,##0"}),n=s.lastRow?s.lastRow.number+2:n+2,s.mergeCells(`E${n}:F${n}`);const L=s.getCell(`E${n}`);L.value="إجمالي المبالغ:",L.font={name:"Arial",size:11,bold:!0},L.alignment={horizontal:"center",vertical:"middle"},s.mergeCells(`G${n}:I${n}`);const o=s.getCell(`G${n}`);o.value=Number(x.totalAmount),o.numFmt='#,##0 "ريال"',o.font={name:"Arial",size:11,bold:!0,color:{argb:"006600"}},o.alignment={horizontal:"center",vertical:"middle"};const g=await a.xlsx.writeBuffer(),Ae=`حوالات-العمال-${new Date().toLocaleDateString("en-GB").replace(/\//g,"-")}.xlsx`;await ht(g,Ae)};return t.jsxs("div",{className:"p-4 space-y-4",dir:"rtl",children:[t.jsx(Ke,{statsRows:Ne,searchValue:j,onSearchChange:ee,searchPlaceholder:"ابحث عن عامل أو مستلم...",showSearch:!0,filters:Ce,filterValues:{worker:h,transferMethod:m},onFilterChange:De,onReset:Te,onRefresh:Se,isRefreshing:be,actions:[{key:"export",icon:Qe,label:"تصدير Excel",onClick:Ie,variant:"outline",disabled:i.length===0,tooltip:"تصدير إلى Excel"}]}),ye?t.jsx(fe,{children:t.jsxs(pe,{className:"text-center py-12",children:[t.jsx("div",{className:"animate-spin w-8 h-8 border-2 border-primary border-t-transparent rounded-full mx-auto mb-4"}),t.jsx("p",{className:"text-muted-foreground",children:"جاري تحميل الحوالات..."})]})}):i.length===0?t.jsx(fe,{children:t.jsxs(pe,{className:"p-8 text-center",children:[t.jsx(J,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),t.jsx("h3",{className:"text-lg font-medium text-foreground mb-2",children:"لا توجد حوالات"}),t.jsx("p",{className:"text-muted-foreground mb-4",children:j||h!=="all"||m!=="all"?"لا توجد نتائج مطابقة للفلاتر المحددة":"لم يتم إرسال أي حوالات بعد"}),t.jsxs(X,{onClick:()=>{C(null),z(),b(!0)},className:"bg-blue-600 hover:bg-blue-700",children:[t.jsx(Ve,{className:"h-4 w-4 ml-2"}),"إرسال حولة جديدة"]})]})}):t.jsx(Ue,{columns:2,children:i.map(e=>{const a=v.find(n=>n.id===e.workerId),s=V.find(n=>n.id===e.projectId);return t.jsx(Oe,{title:a?.name||"عامل غير معروف",subtitle:s?.name||"مشروع غير معروف",titleIcon:ge,badges:[{label:a?.type||"غير محدد",variant:"secondary"},{label:de(e.transferMethod),variant:e.transferMethod==="cash"?"success":e.transferMethod==="bank"?"warning":"default"}],fields:[{label:"المبلغ",value:T(e.amount),icon:me,color:"success",emphasis:!0},{label:"التاريخ",value:ce(e.transferDate),icon:He,color:"muted"},{label:"المستلم",value:e.recipientName,icon:ge,color:"info"},{label:"الهاتف",value:e.recipientPhone||"-",icon:Ye,color:"muted"}],actions:[{icon:Ge,label:"تعديل",onClick:()=>ve(e),color:"blue"},{icon:Be,label:"حذف",onClick:()=>je.mutate(e.id),color:"red"}],footer:e.notes?t.jsxs("p",{className:"text-xs text-muted-foreground",children:[t.jsx("span",{className:"font-medium",children:"ملاحظات:"})," ",e.notes]}):void 0,compact:!0},e.id)})}),t.jsx(Je,{open:we,onOpenChange:b,children:t.jsxs(Xe,{className:"max-w-md",children:[t.jsxs(Ze,{children:[t.jsx(et,{children:A?"تعديل الحولة":"حولة جديدة"}),t.jsx(tt,{children:A?"قم بتعديل بيانات الحولة المالية":"إنشاء حولة مالية جديدة للعامل"})]}),t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[t.jsxs("div",{className:"flex flex-col gap-1.5",children:[t.jsx(w,{children:"العامل *"}),t.jsx(at,{value:r.workerId,onValueChange:e=>c({...r,workerId:e}),workers:v,placeholder:"اختر العامل"})]}),t.jsxs("div",{className:"flex flex-col gap-1.5",children:[t.jsx(w,{children:"المشروع *"}),t.jsx(rt,{value:r.projectId,onValueChange:e=>c({...r,projectId:e}),projects:V,placeholder:"اختر المشروع"})]})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[t.jsxs("div",{children:[t.jsx(w,{children:"المبلغ (ر.ي) *"}),t.jsx(st,{type:"number",inputMode:"decimal",step:"0.01",value:r.amount||"",onChange:e=>{const a=e.target.value;c({...r,amount:a?parseFloat(a):0})},placeholder:"0.00",autoWidth:!0,maxWidth:200,min:"0",className:"text-center arabic-numbers"})]}),t.jsxs("div",{children:[t.jsx(w,{children:"التاريخ *"}),t.jsx(nt,{value:r.transferDate,onChange:e=>c({...r,transferDate:e?ot(e,"yyyy-MM-dd"):""}),className:"w-full"})]})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[t.jsxs("div",{children:[t.jsx(w,{children:"المستلم *"}),t.jsx(_,{category:"recipientNames",value:r.recipientName,onChange:e=>c({...r,recipientName:e}),placeholder:"اسم المستلم"})]}),t.jsxs("div",{children:[t.jsx(w,{children:"طريقة التحويل *"}),t.jsxs(lt,{value:r.transferMethod,onValueChange:e=>c({...r,transferMethod:e}),children:[t.jsx(it,{children:t.jsx(ct,{placeholder:"اختر الطريقة"})}),t.jsxs(dt,{children:[t.jsx(Z,{value:"hawaleh",children:"حولة"}),t.jsx(Z,{value:"cash",children:"نقداً"}),t.jsx(Z,{value:"bank",children:"تحويل بنكي"})]})]})]})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[t.jsxs("div",{children:[t.jsx(w,{children:"رقم الهاتف"}),t.jsx(_,{category:"recipientPhones",value:r.recipientPhone,onChange:e=>c({...r,recipientPhone:e}),placeholder:"رقم الهاتف"})]}),t.jsxs("div",{children:[t.jsx(w,{children:"رقم التحويل"}),t.jsx(_,{category:"workerTransferNumbers",value:r.transferNumber,onChange:e=>c({...r,transferNumber:e}),placeholder:"رقم التحويل"})]})]}),t.jsxs("div",{children:[t.jsx(w,{children:"ملاحظات"}),t.jsx(_,{category:"workerTransferNotes",value:r.notes,onChange:e=>c({...r,notes:e}),placeholder:"ملاحظات إضافية...",autoWidth:!0,maxWidth:400})]}),t.jsxs("div",{className:"flex gap-2 pt-4",children:[t.jsxs(X,{onClick:ke,disabled:U.isPending||O.isPending,className:"flex-1 bg-blue-600 hover:bg-blue-700",children:[U.isPending||O.isPending?t.jsx("div",{className:"animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full ml-2"}):t.jsx(J,{className:"h-4 w-4 ml-2"}),A?"تحديث الحولة":"إرسال الحولة"]}),t.jsx(X,{type:"button",variant:"outline",onClick:()=>{b(!1),C(null),z()},children:"إلغاء"})]})]})]})})]})}export{wt as default};
