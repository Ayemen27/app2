import{ap as Q,a as V,r,c as q,X as K,bm as X,j as e,l as d,a2 as i,aa as o,m as x,I as z,B as E,an as J,bK as U,bL as W,bH as Y,$ as B}from"./index-B6h8JrZe.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Z=Q("Table2",[["path",{d:"M9 3H5a2 2 0 0 0-2 2v4m6-6h10a2 2 0 0 1 2 2v4M9 3v18m0 0h10a2 2 0 0 0 2-2V9M9 21H5a2 2 0 0 1-2-2V9m0 0h18",key:"gugj83"}]]);function ee(){const{toast:m}=V(),[n,D]=r.useState([]),[g,w]=r.useState(!0),[F,H]=r.useState(0),[I,M]=r.useState(0),[N,A]=r.useState(null),[k,G]=r.useState(""),[j,O]=r.useState("all"),{setRefreshAction:p}=q(),h=r.useCallback(async()=>{w(!0);try{const s=await K("/api/sync/compare","GET"),{stats:l,tableDetails:y,tables:T}=s.data,v={};for(const t of T||Object.keys(l||{}))try{const a=await X(t);v[t]=a.length}catch{v[t]=0}const b=[];let C=0,S=0;for(const t of T||Object.keys(l||{})){const a=l?.[t]||0,c=v[t]||0,P=y?.[t]?.columns||[];C+=a,S+=c;let u="synced";a===0&&c===0?u="synced":c===0?u="missing":a!==c&&(u="partial"),b.push({tableName:t,serverCount:a,localCount:c,difference:Math.abs(a-c),isSynced:a===c,columns:P,status:u})}b.sort((t,a)=>t.isSynced!==a.isSynced?t.isSynced?1:-1:a.difference-t.difference),D(b),H(C),M(S),m({title:"تم المقارنة بنجاح",description:`${b.length} جدول | الخادم: ${C} | المحلي: ${S}`})}catch(s){m({title:"خطأ في المقارنة",description:s.message,variant:"destructive"})}finally{w(!1)}},[m]);r.useEffect(()=>{h()},[h]),r.useEffect(()=>(p(()=>()=>{h(),m({title:"جاري تحديث بيانات المزامنة..."})}),()=>p(null)),[h,p,m]);const L=n.filter(s=>{const l=s.tableName.toLowerCase().includes(k.toLowerCase()),y=j==="all"||(j==="synced"?s.isSynced:!s.isSynced);return l&&y}),f=n.filter(s=>!s.isSynced).length,R=n.reduce((s,l)=>s+l.difference,0),$=n.length>0?((n.length-f)/n.length*100).toFixed(1):0;return e.jsxs("div",{className:"container mx-auto p-6 space-y-6","data-testid":"sync-comparison-page",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-4",children:[e.jsxs(d,{children:[e.jsx(i,{className:"pb-2",children:e.jsx(o,{className:"text-sm font-medium",children:"الجداول الكلية"})}),e.jsx(x,{children:e.jsx("div",{className:"text-3xl font-bold",children:n.length})})]}),e.jsxs(d,{children:[e.jsx(i,{className:"pb-2",children:e.jsx(o,{className:"text-sm font-medium",children:"سجلات الخادم"})}),e.jsx(x,{children:e.jsx("div",{className:"text-3xl font-bold text-blue-600",children:F.toLocaleString()})})]}),e.jsxs(d,{children:[e.jsx(i,{className:"pb-2",children:e.jsx(o,{className:"text-sm font-medium",children:"السجلات المحلية"})}),e.jsx(x,{children:e.jsx("div",{className:"text-3xl font-bold text-green-600",children:I.toLocaleString()})})]}),e.jsxs(d,{children:[e.jsx(i,{className:"pb-2",children:e.jsx(o,{className:"text-sm font-medium",children:"نسبة التزامن"})}),e.jsx(x,{children:e.jsxs("div",{className:`text-3xl font-bold ${$==="100"?"text-green-600":"text-yellow-600"}`,children:[$,"%"]})})]}),e.jsxs(d,{children:[e.jsx(i,{className:"pb-2",children:e.jsx(o,{className:"text-sm font-medium",children:"غير متزامن"})}),e.jsx(x,{children:e.jsx("div",{className:`text-3xl font-bold ${f===0?"text-green-600":"text-red-600"}`,children:f})})]})]}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsx(z,{placeholder:"ابحث عن جدول...",value:k,onChange:s=>G(s.target.value),className:"flex-1","data-testid":"input-search-table"}),e.jsx("div",{className:"flex gap-2",children:["all","synced","unsynced"].map(s=>e.jsx(E,{variant:j===s?"default":"outline",onClick:()=>O(s),"data-testid":`button-filter-${s}`,className:j===s?"bg-primary text-primary-foreground border-primary":"border-input text-foreground hover:bg-accent hover:text-accent-foreground",children:s==="all"?"الكل":s==="synced"?"متزامن":"غير متزامن"},s))}),e.jsxs(E,{onClick:h,disabled:g,"data-testid":"button-refresh-comparison",className:"bg-primary text-primary-foreground hover:bg-primary/90 border-primary",children:[e.jsx(J,{className:`w-4 h-4 mr-2 ${g?"animate-spin":""}`}),g?"جاري...":"تحديث"]})]}),e.jsxs(d,{children:[e.jsx(i,{children:e.jsxs(o,{className:"flex items-center gap-2",children:[e.jsx(Z,{className:"w-5 h-5"}),"تفاصيل الجداول (",L.length,")"]})}),e.jsx(x,{children:e.jsx("div",{className:"space-y-2","data-testid":"sync-comparison-table",children:L.map(s=>e.jsxs("div",{className:`border rounded-lg p-4 cursor-pointer transition ${s.isSynced?"bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800":"bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800"}`,"data-testid":`table-row-${s.tableName}`,onClick:()=>A(N===s.tableName?null:s.tableName),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1",children:[N===s.tableName?e.jsx(U,{className:"w-5 h-5"}):e.jsx(W,{className:"w-5 h-5"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold",children:s.tableName}),e.jsxs("p",{className:"text-xs text-slate-600 dark:text-slate-400",children:[s.columns.length," عمود"]})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-sm font-semibold",children:["خادم: ",s.serverCount]}),e.jsxs("div",{className:"text-sm",children:["محلي: ",s.localCount]})]}),s.isSynced?e.jsx(Y,{className:"w-6 h-6 text-green-600"}):e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx(B,{className:"w-6 h-6 text-red-600"}),e.jsxs("span",{className:"text-xs font-bold text-red-600",children:["-",s.difference]})]})]})]}),N===s.tableName&&e.jsx("div",{className:"mt-4 pt-4 border-t space-y-2",children:e.jsxs("div",{children:[e.jsxs("h4",{className:"font-semibold text-sm mb-2",children:["الأعمدة (",s.columns.length,"):"]}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-2",children:s.columns.map(l=>e.jsx("div",{className:"text-xs bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded",children:l},l))})]})})]},s.tableName))})})]}),R>0&&e.jsxs(d,{className:"border-yellow-200 dark:border-yellow-800 bg-yellow-50 dark:bg-yellow-900/20",children:[e.jsx(i,{children:e.jsxs(o,{className:"text-yellow-800 dark:text-yellow-200 flex items-center gap-2",children:[e.jsx(B,{className:"w-5 h-5"}),"ملخص الاختلافات"]})}),e.jsxs(x,{className:"space-y-3 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold",children:"إجمالي السجلات المختلفة:"}),e.jsx("span",{className:"float-right text-lg font-bold text-red-600",children:R})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold",children:"الجداول المتأثرة:"}),e.jsx("span",{className:"float-right text-lg font-bold",children:f})]}),e.jsx("p",{className:"text-slate-600 dark:text-slate-400 pt-2",children:"اضغط على أي جدول لعرض تفاصيل الأعمدة والبيانات الكاملة."})]})]})]})}export{ee as default};
