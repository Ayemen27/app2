# AXION - نظام إدارة مشاريع المقاولات
نظام متكامل لإدارة مشاريع المقاولات مبني بـ Vite + React + Express + PostgreSQL

## هيكل المشروع
- **الواجهة**: Vite + React + shadcn/ui + TailwindCSS
- **الخادم**: Express.js + Socket.IO
- **قاعدة البيانات**: PostgreSQL + Drizzle ORM
- **المشترك**: نماذج البيانات والأنواع في `shared/schema.ts`

## الأنظمة الأساسية (48 جدول)
1. **المصادقة والأمان**: تسجيل دخول/خروج، JWT، صلاحيات، سجلات تدقيق
2. **إدارة المشاريع**: إنشاء/تعديل/حذف، أنواع مشاريع، تحويلات مالية
3. **إدارة العمال**: حضور، أجور، حوالات، نثريات، تسويات
4. **الموردين والمشتريات**: موردين، مواد، مشتريات، مدفوعات
5. **إدارة الآبار**: آبار، مهام، محاسبة، مصاريف، تدقيق
6. **المعدات المبسط**: معدات، حركات نقل بين مشاريع
7. **الإشعارات الموحد**: نظام إشعارات واحد مع حالات القراءة
8. **الذكاء الاصطناعي**: محادثات، رسائل، إحصائيات استخدام
9. **النسخ الاحتياطي**: نسخ يدوي/تلقائي، سجلات
10. **التقارير**: مسار واحد موحّد /reports

## معايير تقنية
- اتبع إرشادات `fullstack_js`
- استخدم مكونات `shadcn/ui` للواجهة
- سمات `data-testid` موحدة للاختبار
- جميع الردود بالعربية فقط (تفضيل المستخدم)

## ميثاق عمل الوكيل المحترف (Professional Agent Charter)
1. **الدقة والصدق المطلق**: ممنوع المراوغة، التعميم، أو إعطاء إجابات غير مؤكدة. يتم التصريح الصريح عند عدم المعرفة.
2. **التفكير التحليلي العميق**: الالتزام بالتفكير خطوة بخطوة قبل أي إجابة أو تنفيذ برمي.
3. **الحلول الواقعية والذكية**: اختيار الحل الأكثر قابلية للتنفيذ، مع تقديم بدائل غير تقليدية وأقل كلفة عند فشل الحلول الشائعة.
4. **الشفافية والوضوح**: توضيح كافة الافتراضات قبل البناء عليها، وطلب المعلومات الناقصة بوضوح تام.
5. **منع الخداع والمجاملة**: تقديم الواقع التقني والعملي كما هو، حتى لو كان غير مريح للمستخدم. الحقيقة التقنية تتقدم على الإرضاء الزائف.
6. **منع التسرع**: تقييم كل خيار قبل اعتماده، وتجنب تقديم أول إجابة تخطر على الذهن.

## قواعد الحوكمة الصارمة (Governance Rules)
1. **سياسة المكون الموحد**: يمنع منعاً باتاً استخدام وسم `<textarea>` أو `<input>` الخام لأي إدخال نصي أو متعدد الأسطر في أي صفحة أو نموذج. يجب استخدام مكونات `Textarea` و `Input` الموحدة من `@/components/ui`.
2. **التحقق من السلوك**: أي حقل إدخال لا يدعم التوسع التلقائي (Auto-height) في حالة النصوص الطويلة أو يظهر شريط تمرير (Scrollbar) قبل الحد الأقصى يعتبر خللاً نظامياً (Systemic Bug).
3. **توحيد التجربة**: يجب أن تتطابق جميع حقول الإدخال في التطبيق من حيث السلوك، الإكمال، والاستجابة.
4. **منع الاستخدام المباشر**: أي كود يحتوي على `<textarea>` أو `<input type="text">` خارج مكتبة المكونات يعتبر مخالفة صريحة تمنع دمج الكود.
5. **الفحص الشامل**: تم إجراء فحص شامل بتاريخ 2026-02-10 للتأكد من خلو المشروع تماماً من أي عناصر إدخال خام. أي انحراف مستقبلي هو مسؤولية المطور.

## معمارية React Query (مركزية مفاتيح الاستعلام)
- **الملف المركزي**: `client/src/constants/queryKeys.ts` - يحتوي جميع مفاتيح الاستعلام (~100+ مورد)
- **ملف نقاط النهاية**: `client/src/constants/api.ts` - يحتوي جميع مسارات API المركزية
- **القواعد**:
  1. يمنع استخدام مفاتيح استعلام نصية مباشرة في أي صفحة أو hook
  2. جميع المفاتيح تمر عبر `QUERY_KEYS.xxx` أو `QUERY_KEYS.xxx(param)`
  3. إبطال الكاش يكون محدد النطاق فقط: `invalidateQueries({ queryKey: QUERY_KEYS.specific, refetchType: 'active' })`
  4. يمنع استخدام `invalidateQueries()` بدون queryKey (إبطال شامل)
  5. المفاتيح الديناميكية تستخدم دوال محددة: `QUERY_KEYS.dailyExpenses(projectId, date)`
- **الملفات المرحّلة**: جميع ملفات `client/src/` بدون استثناء (pages + components + hooks + contexts + lib)
- **التغطية**: صفر مفاتيح نصية مباشرة متبقية في كامل المشروع (تم التحقق بـ grep)
- **نمط المفاتيح البادئة**: مفاتيح مثل `autocompleteFanTypesPrefix` تُستخدم لإبطال كاش جميع المفاتيح التي تبدأ بنفس البادئة (prefix-match invalidation)
- **تم حذفه**: `client/src/constants/api-endpoints.ts` (كان مكرراً)

## التغييرات الأخيرة
- 2026-02-13: إصلاح الشاشة البيضاء عند تصدير Excel/PDF في Android WebView - توحيد جميع مسارات التصدير (10 ملفات) عبر webview-download.ts + Capacitor Filesystem/Share + إزالة كاملة لـ file-saver/saveAs + حماية window.open بـ isMobileWebView()
- 2026-02-13: ترحيل كامل (100%) لجميع ملفات offline + pages لاستخدام storage-factory - إزالة getDB من sync.ts, silent-sync.ts, data-compression.ts, index.ts, SystemCheckPage.tsx, sync-comparison.tsx + singleton guard لـ silentSync + deprecation tag لـ getDB export
- 2026-02-13: بناء APK v1.0.30 (29MB) - إصلاح كشف Capacitor + إصلاح forceSyncTable (كان يستخدم IndexedDB transaction) + إزالة server section من capacitor.config
- 2026-02-13: بناء APK v1.0.29 بنجاح (27MB) - إصلاح capacitor.config.json (كان com.replit.agentforge) + إصلاح gradlew wrapper (كان يستخدم Gradle 4.4.1 النظام)
- 2026-02-13: تنظيف السيرفر الخارجي من ملفات قديمة وإصلاح npm dependency conflict (eslint)
- 2026-02-13: رفع الاختبارات إلى 156 اختبار (100% نجاح) - CRUD, Security, Matching, Offline
- 2026-02-13: إضافة 10 فهارس قاعدة بيانات للجداول الأكثر استعلاماً
- 2026-02-13: إعادة تفعيل generalRateLimit مع handler مخصص يضمن استجابة JSON (كان معطّلاً)
- 2026-02-13: إصلاح اختبارات offline (25 اختبار) - إعادة كتابة conflict/db/sync tests للعمل بدون IndexedDB
- 2026-02-12: بناء APK v1.0.28 بنجاح عبر السيرفر الخارجي (28MB) + 48 اختبار تلقائي (100% نجاح)
- 2026-02-12: اكتمال معمارية React Query المركزية - ترحيل 50+ ملف لاستخدام QUERY_KEYS (مراجعة PASS)

## البناء والنشر
- **سيرفر البناء:** 93.127.142.144 (SSH: administrator)
- **Android SDK:** /opt/android-sdk
- **Gradle:** 8.11.1 | **AGP:** 8.9.1 | **compileSdk:** 36 | **minSdk:** 24
- **أمر البناء:** `bash scripts/remote-build.sh`
- **أمر الاختبار:** `npx vitest run --config vitest.server.config.ts`

## تفضيلات المستخدم
- اللغة: العربية فقط - لا يفهم الإنجليزية
- النهج: احترافي مع مراجعة معمارية
- الأولوية: التنظيف والدمج قبل إضافة ميزات جديدة

## ملاحظات مهمة
- generalRateLimit مفعّل (5000 طلب/15 دقيقة، handler JSON مخصص)
- الملف server/modules/core/schema-backup.ts هو نسخة احتياطية مرجعية فقط
- المنفذ: 5000 (الواجهة والخادم معًا)
