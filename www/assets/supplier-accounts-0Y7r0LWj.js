const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-CISX-da0.js","assets/index-G-27xJUd.css"])))=>i.map(i=>d[i]);
import{r as m,c as ye,d as fe,a as be,f as S,h as Ce,U as Q,W as V,C as ve,Z as Ae,a3 as R,D as J,a4 as we,T as E,a5 as Z,a6 as X,a7 as Y,j as c,i as Fe,k as Se,o as ee,v as xe,$ as Te,a8 as te,l as ae,m as le,n as De,s as Pe,p as $e,q as je,V as T,_ as ke,R as ze}from"./index-CISX-da0.js";function Ue(){const[o,I]=m.useState("all"),[v,N]=m.useState(""),[A,q]=m.useState(""),[j,L]=m.useState(""),[n,_]=m.useState("all"),[re,K]=m.useState(!1),{setFloatingAction:k}=ye(),{selectedProjectId:D,getProjectIdForApi:U}=fe(),{toast:W}=be();m.useEffect(()=>(k(null),()=>k(null)),[k]);const{data:B=[]}=S({queryKey:["/api/projects"],queryFn:async()=>{try{const e=await T("/api/projects","GET");return e&&e.data&&Array.isArray(e.data)?e.data:Array.isArray(e)?e:[]}catch(e){return console.error("Error fetching projects:",e),[]}}}),{data:w=[],isLoading:Re,error:Ee}=S({queryKey:["/api/suppliers"],queryFn:async()=>{try{const e=await T("/api/suppliers","GET");return e&&e.data&&Array.isArray(e.data)?e.data:Array.isArray(e)?e:[]}catch(e){return console.error("Error fetching suppliers:",e),[]}},staleTime:6e4,refetchOnWindowFocus:!1}),{data:P}=S({queryKey:["/api/material-purchases/date-range"],staleTime:3e5}),G=Array.isArray(w)?w.filter(e=>e.name.toLowerCase().includes(j.toLowerCase())):[],{data:s=[],isLoading:oe}=S({queryKey:["/api/material-purchases",D,o,v,A,n],queryFn:async()=>{const e=new URLSearchParams;o&&o!=="all"&&e.append("supplierId",o);const r=U();if(r&&e.append("projectId",r),v&&e.append("dateFrom",v),A&&e.append("dateTo",A),n&&n!=="all"){const a=n==="أجل"?"آجل":n;e.append("purchaseType",a)}try{const a=await T(`/api/material-purchases?${e.toString()}`),t=a.data||a||[];let d=Array.isArray(t)?t:[];if(n&&n!=="all"){const f=n==="أجل"?"آجل":n;d=d.filter(C=>{const F=C.purchaseType?.replace(/['"]/g,"")||"";return F===f||f==="آجل"&&(F==="أجل"||F==="آجل")})}return d}catch(a){return console.error("خطأ في جلب المشتريات:",a),[]}},refetchOnWindowFocus:!1,staleTime:3e4}),{data:Ie}=S({queryKey:["/api/suppliers/statistics"],queryFn:async()=>({totalSuppliers:0,totalCashPurchases:"0",totalCreditPurchases:"0",totalDebt:"0",totalPaid:"0",remainingDebt:"0",activeSuppliers:0}),enabled:!1}),{data:Ne}=S({queryKey:["/api/suppliers/statistics",D,o,v,A,n],queryFn:async()=>{const e=new URLSearchParams;o&&o!=="all"&&e.append("supplierId",o);const r=U();if(r&&e.append("projectId",r),v&&e.append("dateFrom",v),A&&e.append("dateTo",A),n&&n!=="all"){const a=n==="أجل"?"آجل":n;e.append("purchaseType",a)}try{const a=await T(`/api/suppliers/statistics?${e.toString()}`);return a.data||a||{totalSuppliers:0,totalCashPurchases:"0",totalCreditPurchases:"0",totalDebt:"0",totalPaid:"0",remainingDebt:"0",activeSuppliers:0}}catch{return{totalSuppliers:0,totalCashPurchases:"0",totalCreditPurchases:"0",totalDebt:"0",totalPaid:"0",remainingDebt:"0",activeSuppliers:0}}},refetchOnWindowFocus:!1,staleTime:3e4}),g=o&&o!=="all"?w.find(e=>e.id===o):null,h=Array.isArray(s)?s.reduce((e,r)=>(e.totalAmount+=parseFloat(r.totalAmount||"0"),e.paidAmount+=parseFloat(r.paidAmount||"0"),e.remainingAmount+=parseFloat(r.remainingAmount||"0"),e),{totalAmount:0,paidAmount:0,remainingAmount:0}):{totalAmount:0,paidAmount:0,remainingAmount:0},{summary:x,isLoading:qe}=Ce(),M=o&&o!=="all"||D&&D!=="all"||v||A||n&&n!=="all"||j,b={totalSuppliers:w.length,totalCashPurchases:M?Array.isArray(s)?s.filter(e=>e.purchaseType==="نقد").reduce((e,r)=>e+parseFloat(r.totalAmount||"0"),0).toString():"0":(x?.totalCashMaterials||"0").toString(),totalCreditPurchases:M?Array.isArray(s)?s.filter(e=>e.purchaseType==="آجل"||e.purchaseType==="أجل").reduce((e,r)=>e+parseFloat(r.totalAmount||"0"),0).toString():"0":(x?.totalCreditMaterials||"0").toString(),totalDebt:x?.totalSuppliersDebt||"0",totalPaid:x?.totalSuppliersPaid||"0",remainingDebt:x?.totalSuppliersDebt||"0",activeSuppliers:w.filter(e=>parseFloat(e.totalDebt||"0")>0).length,totalPurchases:Array.isArray(s)?s.length:0},O=e=>new Date(e).toLocaleDateString("en-GB",{year:"numeric",month:"2-digit",day:"2-digit"}),i=e=>(typeof e=="string"?parseFloat(e):e).toLocaleString("en-US")+" ريال",ie=async()=>{if(s.length===0)return;const e=(await ke(async()=>{const{default:l}=await import("./index-CISX-da0.js").then(p=>p.e);return{default:l}},__vite__mapDeps([0,1]))).default,r=new e.Workbook,a=r.addWorksheet("كشف حساب المورد");a.views=[{rightToLeft:!0}],a.pageSetup={paperSize:9,orientation:"portrait",fitToPage:!0,fitToWidth:1,fitToHeight:0,margins:{left:.2,right:.2,top:.3,bottom:.3,header:.1,footer:.1},horizontalCentered:!0,scale:80},a.columns=[{width:3},{width:9},{width:12},{width:16},{width:20},{width:6},{width:9},{width:11},{width:8},{width:9},{width:9},{width:8}];let t=1;a.mergeCells(`A${t}:L${t}`);const d=a.getCell(`A${t}`);d.value="شركة الفتيني للمقاولات والاستشارات الهندسية",d.font={name:"Arial",size:14,bold:!0,color:{argb:"FFFFFF"}},d.alignment={horizontal:"center",vertical:"middle"},d.fill={type:"pattern",pattern:"solid",fgColor:{argb:"1f4e79"}},a.getRow(t).height=25,t++,a.mergeCells(`A${t}:L${t}`);const f=a.getCell(`A${t}`);if(f.value="كشف حساب المورد - تقرير مفصل",f.font={name:"Arial",size:11,bold:!0,color:{argb:"1f4e79"}},f.alignment={horizontal:"center",vertical:"middle"},f.fill={type:"pattern",pattern:"solid",fgColor:{argb:"f2f2f2"}},a.getRow(t).height=16,t+=2,g){a.mergeCells(`A${t}:L${t}`);const l=a.getCell(`A${t}`);l.value="بيانات المورد",l.font={name:"Arial",size:11,bold:!0,color:{argb:"FFFFFF"}},l.alignment={horizontal:"center",vertical:"middle"},l.fill={type:"pattern",pattern:"solid",fgColor:{argb:"2e75b6"}},a.getRow(t).height=22,t++,[["اسم المورد",g.name,"رقم الهاتف",g.phone||"غير محدد"],["شخص الاتصال",g.contactPerson||"غير محدد","العنوان",g.address||"غير محدد"]].forEach(y=>{const u=a.getRow(t);a.mergeCells(`A${t}:B${t}`),u.getCell(1).value=y[0],u.getCell(1).font={name:"Arial",size:9,bold:!0},u.getCell(1).alignment={horizontal:"center",vertical:"middle"},a.mergeCells(`C${t}:F${t}`),u.getCell(3).value=y[1],u.getCell(3).font={name:"Arial",size:9},u.getCell(3).alignment={horizontal:"center",vertical:"middle"},a.mergeCells(`G${t}:H${t}`),u.getCell(7).value=y[2],u.getCell(7).font={name:"Arial",size:9,bold:!0},u.getCell(7).alignment={horizontal:"center",vertical:"middle"},a.mergeCells(`I${t}:L${t}`),u.getCell(9).value=y[3],u.getCell(9).font={name:"Arial",size:9},u.getCell(9).alignment={horizontal:"center",vertical:"middle"},a.getRow(t).height=18,t++}),t+=1}const C=["#","التاريخ","رقم الفاتورة","اسم المشروع","المادة","الكمية","سعر الوحدة","المبلغ الإجمالي","نوع الدفع","المدفوع","المتبقي","الحالة"],F=a.getRow(t);C.forEach((l,p)=>{const y=F.getCell(p+1);y.value=l,y.font={name:"Arial",size:9,bold:!0,color:{argb:"FFFFFF"}},y.alignment={horizontal:"center",vertical:"middle",wrapText:!0},y.fill={type:"pattern",pattern:"solid",fgColor:{argb:"1f4e79"}}}),F.height=20,t++,s.forEach((l,p)=>{const y=a.getRow(t),u=B.find(z=>z.id===l.projectId)?.name||"غير محدد",ge=l.materialName||"غير محدد";[p+1,O(l.invoiceDate||l.purchaseDate),l.invoiceNumber||"-",u,ge,l.quantity,parseFloat(l.unitPrice),parseFloat(l.totalAmount),l.purchaseType,parseFloat(l.paidAmount||"0"),parseFloat(l.remainingAmount||"0"),parseFloat(l.remainingAmount||"0")===0?"مسدد":"مؤجل"].forEach((z,he)=>{const $=y.getCell(he+1);$.value=z,$.font={name:"Arial",size:8},$.alignment={horizontal:"center",vertical:"middle",wrapText:!0},$.border={top:{style:"thin",color:{argb:"cccccc"}},bottom:{style:"thin",color:{argb:"cccccc"}},left:{style:"thin",color:{argb:"cccccc"}},right:{style:"thin",color:{argb:"cccccc"}}}}),a.getRow(t).height=18,t++}),t+=2,[["إجمالي المشتريات",i(h.totalAmount)],["إجمالي المدفوع",i(h.paidAmount)],["إجمالي المتبقي",i(h.remainingAmount)]].forEach(l=>{const p=a.getRow(t);a.mergeCells(`H${t}:I${t}`),p.getCell(8).value=l[0],p.getCell(8).font={name:"Arial",size:10,bold:!0},p.getCell(8).alignment={horizontal:"center",vertical:"middle"},a.mergeCells(`J${t}:L${t}`),p.getCell(10).value=l[1],p.getCell(10).font={name:"Arial",size:10,bold:!0},p.getCell(10).alignment={horizontal:"center",vertical:"middle"},a.getRow(t).height=20,t++});const pe=await r.xlsx.writeBuffer(),H=new Date().toISOString().split("T")[0],me=g?`كشف-حساب-${g.name}-${H}.xlsx`:`كشف-حساب-جميع-الموردين-${H}.xlsx`;await ze(pe,me)},ne=m.useCallback(()=>{I("all"),N(""),q(""),L(""),_("all")},[]),se=m.useCallback(async()=>{K(!0),await new Promise(e=>setTimeout(e,500)),K(!1)},[]);m.useEffect(()=>{o&&P&&(N(P.minDate),q(P.maxDate))},[o,P]);const ce=m.useMemo(()=>[{columns:3,gap:"sm",items:[{key:"totalSuppliers",label:"إجمالي الموردين",value:b.totalSuppliers.toString(),icon:Q,color:"blue"},{key:"cashPurchases",label:"المشتريات النقدية",value:i(b.totalCashPurchases),icon:V,color:"green"},{key:"creditPurchases",label:"المشتريات الآجلة",value:i(b.totalCreditPurchases),icon:ve,color:"orange"},{key:"remainingDebt",label:"إجمالي المديونية",value:i(b.remainingDebt),icon:Ae,color:"red"},{key:"activeSuppliers",label:"موردين نشطين",value:b.activeSuppliers.toString(),icon:R,color:"purple"},{key:"totalPaid",label:"إجمالي المدفوع",value:i(b.totalPaid),icon:J,color:"emerald"}]},...o&&o!=="all"?[{columns:3,gap:"sm",items:[{key:"supplierTotal",label:"مشتريات المورد",value:i(h.totalAmount),icon:we,color:"purple"},{key:"supplierPaid",label:"المدفوع للمورد",value:i(h.paidAmount),icon:E,color:"green"},{key:"supplierRemaining",label:"المتبقي على المورد",value:i(h.remainingAmount),icon:Z,color:"red"},{key:"supplierInvoices",label:"عدد الفواتير",value:s.length.toString(),icon:X,color:"blue"},{key:"averageInvoice",label:"متوسط الفاتورة",value:i(s.length>0?h.totalAmount/s.length:0),icon:Y,color:"amber"},{key:"paymentProgress",label:"نسبة السداد",value:h.totalAmount>0?`${(h.paidAmount/h.totalAmount*100).toFixed(1)}%`:"0%",icon:E,color:"teal"}]}]:[]],[b,h,s.length,o,i]),ue=m.useMemo(()=>[{key:"supplier",label:"المورد",type:"select",placeholder:"اختر المورد",options:[{value:"all",label:"جميع الموردين"},...G.map(e=>({value:e.id,label:`${e.name}${parseFloat(e.totalDebt)>0?` - ${i(e.totalDebt)}`:""}`}))]},{key:"paymentType",label:"نوع الدفع",type:"select",placeholder:"نوع الدفع",options:[{value:"all",label:"جميع الأنواع"},{value:"نقد",label:"نقد"},{value:"أجل",label:"أجل"}]}],[G,i]),de=m.useCallback((e,r)=>{e==="supplier"?I(r):e==="paymentType"&&_(r)},[]);return c.jsxs("div",{className:"p-4 space-y-4",dir:"rtl",children:[c.jsx(Fe,{statsRows:ce,searchValue:j,onSearchChange:L,searchPlaceholder:"ابحث عن مورد...",showSearch:!0,filters:ue,filterValues:{supplier:o,paymentType:n},onFilterChange:de,onReset:ne,onRefresh:se,isRefreshing:re,actions:[{key:"export",label:"تصدير",icon:Se,onClick:ie,disabled:s.length===0}]}),g&&c.jsx(ee,{title:g.name,subtitle:"معلومات المورد",titleIcon:te,headerColor:"#3b82f6",fields:[{label:"المسؤول",value:g.contactPerson||"غير محدد",icon:Q,color:"default"},{label:"الهاتف",value:g.phone||"غير محدد",icon:xe,color:"info"},{label:"العنوان",value:g.address||"غير محدد",icon:Te,color:"default"},{label:"المديونية",value:i(b.remainingDebt),icon:V,color:"danger",emphasis:!0}],compact:!0}),c.jsx("div",{className:"space-y-3",children:oe?c.jsx(ae,{children:c.jsxs(le,{className:"text-center py-12",children:[c.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"}),c.jsx("p",{className:"text-gray-600 mt-2",children:"جاري تحميل البيانات..."})]})}):s.length===0?c.jsx(ae,{children:c.jsxs(le,{className:"text-center py-12",children:[c.jsx(Y,{className:"w-12 h-12 text-gray-400 mx-auto"}),c.jsx("p",{className:"text-gray-500 text-lg mt-2",children:"لا توجد مشتريات"}),c.jsx("p",{className:"text-gray-400 text-sm",children:"جرب تغيير فلاتر البحث أو أضف مشتريات جديدة"})]})}):c.jsx(De,{columns:2,children:s.map(e=>{const r=B.find(C=>C.id===e.projectId)?.name||"غير محدد",a=e.materialName||"غير محدد",t=e.supplierName||w.find(C=>C.id===e.supplierId)?.name||"غير محدد",d=parseFloat(e.remainingAmount||"0"),f=e.invoiceDate||e.purchaseDate;return c.jsx(ee,{title:a,subtitle:r,titleIcon:R,headerColor:d===0?"#22c55e":e.purchaseType==="نقد"?"#3b82f6":"#ef4444",badges:[{label:d===0?"مسدد":"مؤجل",variant:d===0?"success":"destructive"},{label:e.purchaseType,variant:e.purchaseType==="نقد"?"default":"warning"}],actions:[{icon:$e,label:"تعديل",onClick:()=>{window.location.href=`/material-purchase?edit=${e.id}`},color:"blue"},{icon:je,label:"حذف",onClick:async()=>{if(confirm("هل أنت متأكد من حذف هذه المشترى؟"))try{await T(`/api/material-purchases/${e.id}`,"DELETE"),await queryClient.invalidateQueries({queryKey:["/api/material-purchases"]}),await queryClient.invalidateQueries({queryKey:["/api/suppliers"]}),await queryClient.invalidateQueries({queryKey:["/api/suppliers/statistics"]}),W({title:"✅ تم الحذف",description:"تم حذف المشترى بنجاح"})}catch{W({title:"❌ خطأ",description:"فشل حذف المشترى",variant:"destructive"})}},color:"red"}],fields:[{label:"المورد",value:t,icon:te,color:"info"},{label:"رقم الفاتورة",value:e.invoiceNumber||"بدون رقم",icon:X,color:"default"},{label:"التاريخ",value:O(f),icon:Pe,color:"muted"},{label:"الكمية",value:`${e.quantity} × ${i(e.unitPrice)}`,icon:R,color:"default"},{label:"المبلغ الإجمالي",value:i(e.totalAmount),icon:J,color:"info",emphasis:!0},{label:"المدفوع",value:i(e.purchaseType==="نقد"?e.totalAmount:e.paidAmount||"0"),icon:E,color:"success"},{label:"المتبقي",value:i(e.purchaseType==="نقد"?0:e.remainingAmount||"0"),icon:Z,color:(e.purchaseType==="نقد"?0:d)>0?"danger":"success",emphasis:!0}],footer:e.notes?c.jsx("div",{className:"p-2 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded text-xs",children:c.jsx("p",{className:"line-clamp-2 text-amber-800 dark:text-amber-200",children:e.notes})}):void 0,compact:!0},e.id)})})})]})}export{Ue as default};
